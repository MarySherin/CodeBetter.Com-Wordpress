<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Multithreading Question &#8211; One Solution | Jean-Paul S. Boodhoo</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/jpboodhoo/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/jpboodhoo/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/jpboodhoo/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/jpboodhoo/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/jpboodhoo/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Jean-Paul S. Boodhoo' href='http://codebetter.com/jpboodhoo/' />
<link rel='start' title='Greetings' href='http://codebetter.com/jpboodhoo/2007/03/20/greetings/' />
<link rel='prev' title='Learning Some New Stuff &#8211; Adapting And Filtering' href='http://codebetter.com/jpboodhoo/2007/04/16/learning-some-new-stuff-adapting-and-filtering/' />
<link rel='next' title='Help Improve ReSharper' href='http://codebetter.com/jpboodhoo/2007/04/18/help-improve-resharper/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/' />
<link rel='shortlink' href='http://codebetter.com/jpboodhoo/?p=16' />
<link rel="stylesheet" href="http://codebetter.com/jpboodhoo/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/jpboodhoo/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-16" class="post-16 post type-post status-publish format-standard hentry category-c category-featured category-programming">
					<h1 class="entry-title">Multithreading Question &#8211; One Solution</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/jpboodhoo/author/jpboodhoo/" title="View all posts by jpboodhoo">jpboodhoo</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/" title="7:35 pm" rel="bookmark"><span class="entry-date">April 17, 2007</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/jpboodhoo/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/jpboodhoo/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/jpboodhoo/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>This morning had a good question asked:</p>
<p>Q: Basically we&#8217;re writing the billing processing part of our business<br />application.&nbsp; On the 1st and 15th of the month, we bill all our<br />policy holders and it&#8217;s usually 10,000 or so transactions that need to<br />be run.&nbsp; The processor gateway runs as a webservice.&nbsp; Now since these<br />10,000 don&#8217;t rely on each other at all, I figured to speed it up I<br />could run 10-20 at a time in a job.<br />&nbsp;<br />So I wrote this simple class so far, but I&#8217;m not sure if it&#8217;s even<br />close, it just takes a processing date, loads all the queued<br />transactions, and sends them into the authorize and payment manager.<br />It seems that async threads you have to delegate to a void<br />parameterless method, so I built a locked incrementer for the index on<br />the generic list of transactions and try to process them like that.<br />It&#8217;s the while loop stuff that is lame, I&#8217;d really like it to just<br />spawn X number of threads where X is configurable.&nbsp; Maybe I just dont&#8217;<br />get it, here&#8217;s the code though:&nbsp;</p>
<pre>
<div><span>    </span><span>public</span><span> </span><span>class</span><span> Billing
    {
         </span><span>public</span><span> Billing(DateTime ProcessDate)
         {
             _ProcessDate </span><span>=</span><span> ProcessDate;
             PopulateTransactions();
             ExecuteBilling();
         }

         </span><span>private</span><span> Int32 _TransactionIndex </span><span>=</span><span> </span><span>0</span><span>;
         </span><span>private</span><span> List</span><span>&lt;</span><span>Transaction _TransactionsToBill;
         </span><span>private</span><span> DateTime _ProcessDate;

         </span><span>private</span><span> </span><span>void</span><span> PopulateTransactions()
         {
            _TransactionsToBill </span><span>=</span><span> TransactionManager.GetQueuedTransactions(_ProcessDate);
         }

         </span><span>private</span><span> </span><span>void</span><span> ExecuteBilling()
         {
             </span><span>do</span><span>
             {
                 Thread t1 </span><span>=</span><span> </span><span>new</span><span> Thread(</span><span>new</span><span> ThreadStart(ProcessTransaction));
                 t1.Start();

                 Thread t2 </span><span>=</span><span> </span><span>new</span><span> Thread(</span><span>new</span><span> ThreadStart(ProcessTransaction));
                 t2.Start();

                 Thread t3 </span><span>=</span><span> </span><span>new</span><span> Thread(</span><span>new</span><span> ThreadStart(ProcessTransaction));
                 t3.Start();

                 Thread t4 </span><span>=</span><span> </span><span>new</span><span> Thread(</span><span>new</span><span> ThreadStart(ProcessTransaction));
                 t4.Start();

                 Thread t5 </span><span>=</span><span> </span><span>new</span><span> Thread(</span><span>new</span><span> ThreadStart(ProcessTransaction));
                 t5.Start();

             } </span><span>while</span><span> (_TransactionIndex </span><span>&lt;</span><span> _TransactionsToBill.Count);
         }

         </span><span>private</span><span> </span><span>void</span><span> ProcessTransaction()
         {
            </span><span>string</span><span> Message;
            Transaction transaction </span><span>=</span><span> GetNextTransaction();

            </span><span>if</span><span> (transaction </span><span>!=</span><span> </span><span>null</span><span>)

            CyberSourceManager.AuthorizeAndCapture(transaction.InvoiceID,transaction.ID, </span><span>out</span><span> Message);
         }

         </span><span>private</span><span> Transaction GetNextTransaction()
         {
             Interlocked.Increment(</span><span>ref</span><span> _TransactionIndex);
             </span><span>if</span><span> (_TransactionsToBill.Count  _TransactionIndex)
             {
                 </span><span>return</span><span> _TransactionsToBill[_TransactionIndex </span><span>-</span><span> </span><span>1</span><span>];
             }

             </span><span>return</span><span> </span><span>null</span><span>;
         }
    }
    </span></div>
</pre>
<p>A: The main problem that&nbsp;you are&nbsp;concerned about is : &ldquo;I&#8217;d really like it to just spawn X number of threads where X is configurable&rdquo;. The following code is another alternative implemented using the Monitor class to create a producer/consumer queue:</p>
<pre>
<div><span>public</span><span> </span><span>class</span><span> Billing
{
    </span><span>private</span><span> Queue</span><span>&lt;</span><span>Transaction</span><span>&gt;</span><span> transactionQueue;
    </span><span>private</span><span> IList</span><span>&lt;</span><span>Thread</span><span>&gt;</span><span> workerThreads;
    </span><span>private</span><span> </span><span>object</span><span> mutex;

    </span><span>public</span><span> Billing(</span><span>int</span><span> numberOfWorkerThreadsToUse,IEnumerable</span><span>&lt;</span><span>Transaction</span><span>&gt;</span><span> itemsToProcess)
    {
        mutex </span><span>=</span><span> </span><span>new</span><span> </span><span>object</span><span>();
        workerThreads </span><span>=</span><span> </span><span>new</span><span> List</span><span>&lt;</span><span>Thread</span><span>&gt;</span><span>();
        transactionQueue </span><span>=</span><span> </span><span>new</span><span> Queue</span><span>&lt;</span><span>Transaction</span><span>&gt;</span><span>();

        InitializeConsumers(numberOfWorkerThreadsToUse);
        QueueUp(itemsToProcess);
        QueueEmptyTransactionsForEachActiveThread();
    }

    </span><span>private</span><span> </span><span>void</span><span> QueueUp(IEnumerable</span><span>&lt;</span><span>Transaction</span><span>&gt;</span><span> toProcess)
    {
        </span><span>foreach</span><span> (Transaction transaction </span><span>in</span><span> toProcess)
        {
            QueueForProcessing(transaction);
        }
    }

    </span><span>private</span><span> </span><span>void</span><span> QueueEmptyTransactionsForEachActiveThread()
    {
        </span><span>foreach</span><span> (Thread wokerThread </span><span>in</span><span> workerThreads)
        {
            QueueForProcessing(</span><span>null</span><span>);
        }
    }

    </span><span>private</span><span> </span><span>void</span><span> QueueForProcessing(Transaction transaction)
    {
        </span><span>lock</span><span> (mutex)
        {
            transactionQueue.Enqueue(transaction);
            Monitor.PulseAll(mutex);
        }
    }

    </span><span>private</span><span> </span><span>void</span><span> InitializeConsumers(</span><span>int</span><span> numberToInitialize)
    {
        </span><span>for</span><span> (</span><span>int</span><span> i </span><span>=</span><span> </span><span>0</span><span>; i </span><span>&lt;</span><span> numberToInitialize; i</span><span>++</span><span>)
        {
            Thread thread </span><span>=</span><span> </span><span>new</span><span> Thread(ProcessTransactions);
            workerThreads.Add(thread);
            thread.Start();
        }
    }

    </span><span>private</span><span> </span><span>void</span><span> ProcessTransactions()
    {
        </span><span>while</span><span> (</span><span>true</span><span>)
        {
            Transaction transaction </span><span>=</span><span> </span><span>null</span><span>;
            </span><span>lock</span><span> (mutex)
            {
                </span><span>while</span><span> (transactionQueue.Count </span><span>==</span><span> </span><span>0</span><span>) Monitor.Wait(mutex);
                transaction </span><span>=</span><span> transactionQueue.Dequeue();
            }
            </span><span>if</span><span> (transaction </span><span>==</span><span> </span><span>null</span><span>) </span><span>return</span><span>;

            Process(transaction);
        }
    }

    </span><span>private</span><span> </span><span>void</span><span> Process(Transaction transaction)
    {
        </span><span>//</span><span>Do you work here</span><span>
</span><span>    }
}</span></div>
</pre>
<p>The advantage of this code over the prior code is it mitigates unecessary allocation of an unknown number of threads and opts for the creation of an explicit &ldquo;known&rdquo; number of worker threads that will process items on the queue. This code leverages the ability to wait on a locked object. When a transaction is Queued up, Monitor.PulseAll is invoked (on the mutex) to wake up all threads that may already be waiting on that mutex,based on which thread is currently highest in the lock queue, it will be able to Dequeue a single transaction from the &ldquo;transaction&rdquo; queue and process it.</p>
<p>The constructor for the Billing class allows you to specify how many worker threads should be created. You should notice, that the Consumer threads can start immediately processing Transactions the second a Transaction is queued for processing. This has the benefit of not needing to have the queue populated in its entirety before processing. As new items are added to the queue, a worker thread can pick it up and process it. Once all of the real transactions have been added to the queue for processing, a &ldquo;null&rdquo; transaction is placed onto the queue for each worker thread that was created. This ensures that each thread will actually terminate.</p>
<p>Notice how in the ProcessTransactions method, it does not stop processing if the number of items in the queue == 0. This is because (again, multi threaded coding is hard) since items are being added to the queue from a separate thread, and items are being processed by 1 of the many worker threads, the client thread may not have had the opportunity to place items on the queue before the (transactionQueue.Count <span>==</span><span> </span><span>0) condition is evaluated. If I used the count of the items in the queue as my termination condition, the worker thread would most likely terminate too early. Hence the need for the null transaction that each thread will have to handle. Once the worker dequeues a null transaction, it knows that it is time for it to finish.</span></p>
<p><span>I&rsquo;m not saying this is the only way to solve this problem, I just wanted to demonstrate how you could share the load of the processing between a finite amount of worker threads, while utilizing the Monitor class to perform fine grained synchronization.</span></p>
<p><span>The usage for this class becomes very simple:</span></p>
<pre>
<div><span>new</span><span> Billing(</span><span>5</span><span>,transactionService.GetTransactionsToProcess());</span></div>
</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/jpboodhoo/category/c/" title="View all posts in C#" rel="category tag">C#</a>, <a href="http://codebetter.com/jpboodhoo/category/featured/" title="View all posts in Featured" rel="category tag">Featured</a>, <a href="http://codebetter.com/jpboodhoo/category/programming/" title="View all posts in Programming" rel="category tag">Programming</a>. Bookmark the <a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/" title="Permalink to Multithreading Question &#8211; One Solution" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/feed/" title="Comments RSS to Multithreading Question &#8211; One Solution" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-16 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/jpboodhoo/2007/04/16/learning-some-new-stuff-adapting-and-filtering/" rel="prev"><span class="meta-nav">&larr;</span> Learning Some New Stuff &#8211; Adapting And Filtering</a></div>
					<div class="nav-next"><a href="http://codebetter.com/jpboodhoo/2007/04/18/help-improve-resharper/" rel="next">Help Improve ReSharper <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

							<div id="comments">


			<h3 id="comments-title">9 Responses to <em>Multithreading Question &#8211; One Solution</em> </h3>


			<ol class="commentlist">
						<li class="comment even thread-even depth-1" id="li-comment-22">
		<div id="comment-22">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.jpboodhoo.com' rel='external nofollow' class='url'>bitwisejp</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-22">April 20, 2007 at 1:53 pm</a></div>

		<div class="comment-body"><p>@Gary,</p>
<p>Good eye. In this scenario there is no need for me to PulseAll. There is no harm in doing it, but it would definitely be more efficient to Pulse as (you said) the condition all of the threads are waiting on is the same and only a single item can be removed from the queue at a time.</p>
<p>If each of the threads were using the same monitor but watching different queues, then that would be a scenario you would want to use PulseAll.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-21">
		<div id="comment-21">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Garry Shutler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-21">April 20, 2007 at 11:38 am</a></div>

		<div class="comment-body"><p>Is there a reason for using PulseAll rather than Pulse?</p>
<p>As far as I can work out as you add one work item, there&#8217;s only a point in waking one waiting thread.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-20">
		<div id="comment-20">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">jfcantin</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-20">April 18, 2007 at 12:09 pm</a></div>

		<div class="comment-body"><p>It is nice to have that threadPool discussion, but why is all the Queuing and Thread management in Billing? Billing should probably do the billing only and not manage the queue and threads. I like Ayende&#8217;s recommendation which keeps Billing clean. ThreadPool or an home grown one injected in.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-19">
		<div id="comment-19">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-19">April 18, 2007 at 11:01 am</a></div>

		<div class="comment-body"><p>&#8220;I figured to speed it up I could run 10-20 at a time in a job&#8221;</p>
<p>So is it actually faster and worth the increased complexity? I don&#8217;t see anything that could really block, unless CyberSourceManager.AuthorizeAndCapture is really slow. There&#8217;s also some hardware questions to take into account.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-18">
		<div id="comment-18">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://iancooper.spaces.live.com/' rel='external nofollow' class='url'>Ian Cooper</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-18">April 18, 2007 at 7:18 am</a></div>

		<div class="comment-body"><p>The other  threadpool issue is that it does not let me throttle the number of threads that I am using on what is a shared resource. This can lead to thread exhaustion deadlock if we run out of worker threads. This can be mitigated by not peforming actions on our thread which in turn spawn new threads. See the section on deadlocks in the following article: <a href="http://msdn2.microsoft.com/en-us/library/ms973903.aspx" rel="nofollow">http://msdn2.microsoft.com/en-us/library/ms973903.aspx</a></p>
<p>I tend to favour wanting to configure the number of threads used by work processors over jumping into the pool. Jean-Paul&#8217;s monitor based solution seems fairly elegant.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-17">
		<div id="comment-17">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">fatal</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-17">April 17, 2007 at 10:54 pm</a></div>

		<div class="comment-body"><p>Another option would be to use the SmartThreadPool from codeproject &#8211; <a href="http://www.codeproject.com/cs/threads/smartthreadpool.asp" rel="nofollow">http://www.codeproject.com/cs/threads/smartthreadpool.asp</a> . This provides (among many other benefits over ThreadPool) dequeuing of queued workitems if they have not yet commenced execution.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-16">
		<div id="comment-16">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://scourtrille.wordpress.com' rel='external nofollow' class='url'>shanecourtrille</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-16">April 17, 2007 at 10:09 pm</a></div>

		<div class="comment-body"><p>As a completely unrelated comment.. It would actually make the code a lot easier to read (and therefore understand) if the methods were in the same order they are called.</p>
<p>Beyond that little nitpick it&#8217;s cool to see this level of detail.  Though I think Ayende has it right for a large percentage of the situations out there.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-15">
		<div id="comment-15">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.jpboodhoo.com' rel='external nofollow' class='url'>bitwisejp</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-15">April 17, 2007 at 8:43 pm</a></div>

		<div class="comment-body"><p>Hey Ayende,</p>
<p>I was just waiting for someone to post that!! I purposefully chose not to go with ThreadPool, so I could demonstrate explicit fine grained locking semantics. </p>
<p>As a side note,once you have Queued up a work item on the ThreadPool, there is no nice easy way to dequeue that item in case you no longer want to execute it.</p>
<p>Thanks</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-14">
		<div id="comment-14">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.ayende.com/Blog/' rel='external nofollow' class='url'>Ayende Rahien</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/jpboodhoo/2007/04/17/multithreading-question-one-solution/#comment-14">April 17, 2007 at 8:27 pm</a></div>

		<div class="comment-body"><p>Or you could give up manual threading (recommended) and just use the ThreadPool to do it:</p>
<p>for(int i=0;i&lt;10000;i++)<br />
   ThreadPool.QueueUserWorkItem(ProcessTransaction);</p>
<p>And then use a CountdownLatch lock to wait for them to finish</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
			</ol>



								<div id="respond">
				<h3 id="reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/jpboodhoo/2007/04/17/multithreading-question-one-solution/#respond" style="display:none;">Cancel reply</a></small></h3>
									<p class="must-log-in">You must be <a href="http://codebetter.com/jpboodhoo/wp-login.php?redirect_to=http%3A%2F%2Fcodebetter.com%2Fjpboodhoo%2F2007%2F04%2F17%2Fmultithreading-question-one-solution%2F">logged in</a> to post a comment.</p>												</div><!-- #respond -->
						
</div><!-- #comments -->

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter//third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.309 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-25 15:04:58 -->
<!-- super cache -->