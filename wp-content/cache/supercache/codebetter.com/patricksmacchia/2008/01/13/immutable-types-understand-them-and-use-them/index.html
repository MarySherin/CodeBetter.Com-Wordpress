<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Immutable types: understand their benefits and use them | Patrick Smacchia</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/patricksmacchia/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/patricksmacchia/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/patricksmacchia/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/patricksmacchia/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/patricksmacchia/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Patrick Smacchia' href='http://codebetter.com/patricksmacchia/' />
<link rel='start' title='Benefit from the C# and VB.NET compilers perf' href='http://codebetter.com/patricksmacchia/2007/06/20/benefit-from-the-c-and-vb-net-compilers-perf/' />
<link rel='prev' title='Rambling on the sealed keyword' href='http://codebetter.com/patricksmacchia/2008/01/05/rambling-on-the-sealed-keyword/' />
<link rel='next' title='Avoid API breaking changes' href='http://codebetter.com/patricksmacchia/2008/01/20/avoid-api-breaking-changes/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/patricksmacchia/2008/01/13/immutable-types-understand-them-and-use-them/' />
<link rel='shortlink' href='http://codebetter.com/patricksmacchia/?p=34' />
<link rel="stylesheet" href="http://codebetter.com/patricksmacchia/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/codebetter/disqus.css?v=2.0" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/patricksmacchia/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-34" class="post-34 post type-post status-publish format-standard hentry category-uncategorized">
					<h1 class="entry-title">Immutable types: understand their benefits and use them</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/patricksmacchia/author/patricksmacchia/" title="View all posts by patricksmacchia">patricksmacchia</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/patricksmacchia/2008/01/13/immutable-types-understand-them-and-use-them/" title="11:58 am" rel="bookmark"><span class="entry-date">January 13, 2008</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/patricksmacchia/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/patricksmacchia/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/patricksmacchia/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p><span>There is a powerful and simple concept<br />
in programming that I think is really underused: Immutability</span></p>
<p><span>Basically, an object is immutable if<br />
its state doesn’t change once the object has been created. Consequently, a class<br />
is immutable if its instances are immutable. </span></p>
<p><span>There is one killer argument for using<br />
immutable objects: It dramatically simplifies concurrent programming. Think<br />
about it, why does writing proper multithreaded programming is a hard task? Because<br />
it is hard to synchronize threads accesses to resources (objects or others OS things). Why it<br />
is hard to synchronize these accesses? Because it is hard to guarantee that<br />
there won’t be race conditions between the multiple write accesses and read<br />
accesses done by multiple threads on multiple objects. What if there are no<br />
more write accesses? In other words, what if the state of the objects threads<br />
are accessing, doesn’t change? There is no more need for synchronization!</span></p>
<p><span>Of course I simplify here so let&#8217;s dig a bit.</span></p>
<p>&nbsp;</p>
<p><b><span style="font-size: 14pt">A famous immutable class</span></b></p>
<p><span>There is one famous immutable class: <b>System.String</b>. When you think that you<br />
are modifying a string, you actually create a new string object. Often, we<br />
forget about it and we would like to write …</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">string</span><span style="font-size: 10pt;font-family: 'Courier New'"> str = <span>&#8220;foofoo&#8221;</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><s><span style="font-size: 10pt;font-family: 'Courier New'">str.Replace(<span>&#8220;foo&#8221;</span>,<br />
<span>&#8220;FOO&#8221;</span>);</span></s></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><s><span style="font-size: 12pt;font-family: 'Courier New'"><span style="text-decoration: none">&nbsp;</span></span></s></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span>…where we need to write instead:</span><s><span style="font-size: 12pt;font-family: 'Courier New'"></span></s></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New'">str<br />
= str.Replace(<span>&#8220;foo&#8221;</span>, <span>&#8220;FOO&#8221;</span>);</span></p>
<p><span>Of course, doing so comes at the cost<br />
of creating multiple string objects in memory when doing some intensive string<br />
computation. In this case you need to use the <b>System.Text.StringBuilder</b><br />
class that provides a safe way to work with mutable string.</span></p>
<p><span>Actually, string objects are not that<br />
immutable and as far as I know there are at least 2 ways to break string<br />
immutability. With pointers as shown by <a href="http://www.practicaldot.net/Chapter_14/Listing_14_5.htm" target="_blank">this code example</a> and with some advanced <b>System.Reflection</b> usage. </span></p>
<p><span>So why .NET engineers decided that<br />
string should be immutable? Because programmers will never get a race<br />
conditions because of a corrupted string. Also because string are well adapted<br />
to be key in hashtables (i.e <b>Sytem.Collections.generic.Dictionary&lt;K,V&gt;</b>).<br />
Hashtables are almost a magic way to enhance dramatically performance of your<br />
code. (<i>I said magic because under the<br />
hood hashtables rely on prime numbers properties and prime numbers are magic!</i>).<br />
The objects on which the hash values are computed must be immutable to make<br />
sure that the hash values will be constant in time. Indeed, hash value is<br />
computed from the state of the object (or eventually a sub-state of the object,<br />
then only this sub-state must be immutable).</span></p>
<p><span>Another cool thing about string<br />
immutability is that even though <b>System.String</b><br />
is a class, string objects get compared with equivalence, as a value type. This<br />
is possible because we can consider that the identity of an immutable object is<br />
its state. For example: </span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">string</span><span style="font-size: 10pt;font-family: 'Courier New'"> str1 = <span>&#8220;foofoo&#8221;</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">string</span><span style="font-size: 10pt;font-family: 'Courier New'"> strFoo = <span>&#8220;foo&#8221;</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">string</span><span style="font-size: 10pt;font-family: 'Courier New'"> str2 = strFoo + strFoo;</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: green">// Even thought str1 and str2 reference 2 different<br />
objects</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: green">// the following assertion is true.</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span>Debug</span><span style="font-size: 10pt;font-family: 'Courier New'">.Assert(str1 == str2);</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal">&nbsp;</p>
<p><b><span style="font-size: 14pt">Purity vs. Side-effect</span></b></p>
<p style="text-indent: 35.4pt">&nbsp;<br /><span>So we now know at least 3 great benefits<br />
of immutable objects:<br /></span></p>
<ul>
<li><span>They<br />
simplify multithreaded programming.</span><span></span></li>
<li><span>They can be<br />
used as hashtables key.</span><span></span></li>
<li><span>They simplify<br />
state comparison. </span></li>
</ul>
<p><span>We can now be more general and say<br />
that the primary benefit of immutable types come from the fact that they<br />
eliminate side-effects. I couldn’t say it better than <a href="http://blogs.msdn.com/wesdyer/archive/2007/03/01/immutability-purity-and-referential-transparency.aspx" target="_blank">Wes Dyer</a>&nbsp;<span></span>so I quote him:</span></p>
<p><i><span>We<br />
all know that generally it is not a good idea to use global variables.<span>&nbsp; </span>This is basically the extreme of exposing side-effects<br />
(the global scope). Many of the programmers who don&#8217;t use global variables<br />
don&#8217;t realize that the same principles apply to fields, properties, parameters,<br />
and variables on a more limited scale: don&#8217;t mutate them unless you have a good<br />
reason.(…)</span></i></p>
<p><i><span>One<br />
way to increase the reliability of a unit is to eliminate the side-effects.<br />
This makes composing and integrating units together much easier and more<br />
robust.<span>&nbsp; </span>Since they are side-effect free,<br />
they always work the same no matter the environment.<span>&nbsp; </span>This is called referential transparency.</span></i></p>
<p>&nbsp;</p>
<p><b><span style="font-size: 14pt">Immutable classes in C#</span></b></p>
<p><span>C# supports immutability thanks to 2<br />
keywords: <b>const</b> and <b>readonly</b>. They are used by the C#<br />
compiler to ensure that the state of a field won’t be changed once an object is<br />
created. Why 2 keywords? Because the <b>readonly</b><br />
keyword allows state modification within constructor(s) while the <b>const</b> keyword doesn’t. For example:</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">class</span><span style="font-size: 10pt;font-family: 'Courier New'"> <span>Article</span><br />
{<br /><span>&nbsp;&nbsp; </span>Article(<span style="color: blue">string</span><br />
name,<span style="color: blue">int</span> price) { <br /><span></span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'">m_Name = name; <span>//<br />
&lt;- Compilation error<br /></span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'">m_Price = price; <br /><span></span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'">}<br /><span></span><b><span style="color: blue"></span></b></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'"><b><span style="color: blue">const</span></b> <span style="color: blue">string</span><br />
m_Name = <span>&#8220;Ballon&#8221;</span>;<br /><span></span><b><span style="color: blue"></span></b></span><span style="font-size: 10pt;font-family: 'Courier New'"><span>&nbsp;&nbsp; </span></span><span style="font-size: 10pt;font-family: 'Courier New'"><b><span style="color: blue">readonly</span></b> <span style="color: blue">int</span><br />
m_Price;<br />}</span></p>
<p><span>At this point you might wonder what if<br />
my object references another object through a read-only fields? Does the state<br />
of the referenced object can change? The answer is yes, this is the classical<br />
shallow vs. deep paradigm. <i>Eric Lippert</i><br />
from the C# team has a <a href="http://blogs.msdn.com/ericlippert/archive/2007/11/13/immutability-in-c-part-one-kinds-of-immutability.aspx" target="_blank">nice post </a>describing these different kinds of immutability. Actually Eric did a great range<br />
of posts on how to code efficient immutable collections, which might sound<br />
paradox since collections are known as super-mutable objects. Check its posts<br />
done since november 2007! Also Eric wrote:</span></p>
<p><i><span>Immutable<br />
data structures are the way of the future in C#.</span></i></p>
<p><span>So stay tuned!</span></p>
<p>&nbsp;</p>
<p><b><span style="font-size: 14pt">Immutable closures in C#2</span></b></p>
<p><span>The functional coding-style is more<br />
adapted to immutable state than the imperative one. <i>Wesner Moise</i> often praises <a href="http://wesnerm.blogs.com/net_undocumented/2007/10/immutable-data-.html%20" target="_blank">on its blog </a>the use of functional closures as a mean to<br />
achieve immutability. For example, here is a simple program that defines<br />
immutable objects. These objects are affine transformer that take an integer <i>x</i> and that compute <i>a*x+b</i>. Thus, the state of our immutable affine transformer object<br />
are the <i>a</i> and <i>b</i> parameters. Here is the code:</span><span style="font-size: 10pt;font-family: 'Courier New';color: blue"></span></p>
<p><span style="font-size: 10pt;font-family: 'Courier New';color: blue">using</span><span style="font-size: 10pt;font-family: 'Courier New'"> System.Diagnostics;</span><span style="font-size: 10pt;font-family: 'Courier New';color: blue"><br />class</span><span style="font-size: 10pt;font-family: 'Courier New'"> <span>Program</span><br />
{</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br /></span><span></span><span style="color: blue">&nbsp;&nbsp; delegate</span> <span style="color: blue">int</span> <span>DelegateType</span>(<span style="color: blue">int</span><br />
x);</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp; </span><span style="color: blue">static</span> <span>DelegateType</span> MakeAffine(<span style="color: blue">int</span><br />
a, <span style="color: blue">int</span> b) {</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: blue">return</span> <span style="color: blue">delegate</span>(<span style="color: blue">int</span> x) { <span style="color: blue">return</span> a * x + b; };</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp; </span>}</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp; </span><span style="color: blue">static</span> <span style="color: blue">void</span> Main() {</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>DelegateType</span><br />
affine1 = MakeAffine(2, 1);</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>DelegateType</span><br />
affine2 = MakeAffine(3, 4);</span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Debug</span>.Assert(affine1(5)<br />
== 11);<span>&nbsp; </span><span style="color: green">//<br />
2*5+1 == 11</span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>Debug</span>.Assert(affine2(6)<br />
== 22);<span>&nbsp; </span><span style="color: green">//<br />
3*6+4 == 22 </span></span><span style="font-size: 10pt;font-family: 'Courier New'"><span><br />&nbsp;&nbsp; </span>}</span><span style="font-size: 10pt;font-family: 'Courier New'"><br />}</span></p>
<p><span>If you are not acquainted with closure<br />
this code might surprise you. Behind your back, the C# compiler has created an immutable<br />
class to represent these affine transformer objects! I wrote an <a href="http://www.theserverside.net/tt/articles/showarticle.tss?id=AnonymousMethods" target="_blank">article</a> about closure in C# that explains all this.</span></p>
<p>&nbsp;</p>
<p><b><span style="font-size: 14pt">Immutable anonymous types in C#3 and VB9</span></b></p>
<p><span>C#3 comes with the interesting anonymous<br />
types feature. Anonymous types built by the C#3 compiler are immutable, all<br />
fields are private and all properties are read-only (it is always instructive<br />
to check by yourself with Reflector).</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">var</span><span style="font-size: 10pt;font-family: 'Courier New'"> affine = <span style="color: blue">new</span><br />
{ A = 3, B = 4 };</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New'">affine.A<br />
= 3; <span style="color: green">// &lt;- Compilation error</span></span></p>
<p><span>On <a href="http://blogs.msdn.com/timng/archive/2007/05/28/anonymous-types-and-object-identities.aspx" target="_blank">this post</a>,<i> Tim Ng</i> from the VB.NET team, wrote:</span></p>
<p style="margin-left: 35.4pt"><i><span>The motivating factor for driving the immutable<br />
anonymous types was because the LINQ APIs used hash tables internally and<br />
returning projections of anonymous types that could be modified was a dangerous<br />
situation.</span></i></p>
<p><span>Interestingly enough, the VB team<br />
decided that their anonymous types wouldn’t be immutable by default, which<br />
means that you can write such things:</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">Dim</span><span style="font-size: 10pt;font-family: 'Courier New'"> affine = <span style="color: blue">New</span><br />
<span style="color: blue">With</span> {.A = 3, .B = 4}</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="font-size: 10pt;font-family: 'Courier New'">affine.A =<br />
5</span><span style="font-size: 10pt"> </span></p>
<p><span>However, the VB team added the<br />
possibility to specify that a certain property would be read-only thanks to the<br />
<b>Key</b> keyword:</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New';color: blue">Dim</span><span style="font-size: 10pt;font-family: 'Courier New'"> affine = <span style="color: blue">New</span><br />
<span style="color: blue">With</span> {<span style="color: blue">Key </span>.A =<br />
3, .B = 4}</span></p>
<p class="MsoNormal" style="margin-bottom: 0.0001pt;line-height: normal"><span style="font-size: 10pt;font-family: 'Courier New'">affine.A<br />
= 5</span><span style="font-size: 10pt"> <span>&nbsp;&nbsp;&nbsp;</span></span><span style="font-size: 10pt;font-family: 'Courier New';color: green">‘ &lt;- Compilation error</span></p>
<p><span>About the motivation behind having<br />
mutable anonymous types in VB <i>Tim Ng</i> wrote:</span></p>
<p style="margin-left: 35.4pt"><i><span>…but for Visual Basic, we decided that because<br />
we have the ability to late bind on top of anonymous types, making them<br />
immutable is unexpected.</span></i></p>
<p style="margin-left: 35.4pt">&nbsp;</p>
<p><b><span style="font-size: 14pt">Immutable support in NDepend and CQL</span></b></p>
<p><span>As we saw, immutability is a feature<br />
that can be enforced at compile-time. In other words it can be enforced by<br />
static analysis tools. Thus, the <a href="http://www.ndepend.com/Features.aspx#CQL" target="_blank">Code Query Language (CQL)</a> that comes with the static analysis tool <a href="http://www.NDepend.com" target="_blank">NDepend</a> has an <b>IsImmutable</b> condition that applies on<br />
types. To know which types of your code base are immutable it is as easy as<br />
writing this CQL query:</span></p>
<p><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>IsImmutable</span></p>
<p>&nbsp;</p>
<p><span>To constraint a particular type <b>MyNamespace.Foo</b> to be immutable you can<br />
write this CQL constraint:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">!= </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">1</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>IsImmutable</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>FullNameIs</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>&#8220;MyNamespace.Foo&#8221;</span></p>
<p style="margin: 0cm 0cm 0.0001pt">&nbsp;</p>
<p><span>To constraint a range of types used by<br />
the class <b>MyNamespace.Foo</b> to be<br />
immutable:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">&gt; </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">0</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>IsUsedBy </span><span>&#8220;MyNamespace.Foo&#8221;<br />
</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> !</span><span>IsImmutable</span></p>
<p style="margin: 0cm 0cm 0.0001pt">&nbsp;</p>
<p><span>To constraint a range of types<br />
declared in the namespace <b>MyNamespace</b><br />
to be immutable:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">&gt; </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">0</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES<br />
FROM NAMESPACES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>&#8220;MyNamespace &#8220;</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue"> WHERE</span><span> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">!</span><span>IsImmutable</span></p>
<p style="margin: 0cm 0cm 0.0001pt">&nbsp;</p>
<p><span>To constraint a range of types tagged<br />
with an attribute <b>MyNamespace.MyImmutableAttribute</b><br />
to be immutable:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">&gt; </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">0</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>IsDirectlyUsing </span><span>&#8220;MyNamespace.MyImmutableAttribute&#8221;<br />
</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> !</span><span>IsImmutable</span></p>
<p style="margin: 0cm 0cm 0.0001pt">&nbsp;</p>
<p><span>In a near future we will add the<br />
condition <b>HasAttribute</b> and we will<br />
be able to write more properly:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">&gt; </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">0</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>HasAttribute </span><span>&#8220;MyNamespace.MyImmutableAttribute&#8221;<br />
</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> !</span><span>IsImmutable</span></p>
<p style="margin: 0cm 0cm 0.0001pt">&nbsp;</p>
<p><span>There is something about immutability<br />
that we didn’t mention: all primitive value types (int, double, decimal, byte,<br />
bool…) are immutable. More generally it is recommended to make all structures immutable.<br />
It makes them suited for hash value computation, suited for equivalence comparison,<br />
and creating more structure instances won’t overwhelm the GC. To guarantee that<br />
all your structures are immutable just write this constraint:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">&gt; </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">0</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">TYPES</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>IsStructure</span><span> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> !</span><span>IsImmutable</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span></span></p>
<p style="text-indent: 35.4pt">&nbsp;<br /><span>So, what’s behind the <b>IsImmutable</b> CQL condition? Here are the<br />
rules that NDepend uses to decide if a type is immutable or not:</span></p>
<ul>
<li><span>A type with<br />
at least one non-private instance field is considered as mutable (because such<br />
a field can be eventually modified outside of the type).</span><span></span></li>
<li><span>A type that<br />
has a method that is not a constructor and that assign an instance field is<br />
considered as mutable.</span><span></span></li>
<li><span>A class<br />
that derives directly or indirectly from a mutable type is considered as<br />
mutable.</span><span></span></li>
<li><span>Enumeration,<br />
static type, type defined in tier assemblies and delegate classes are never<br />
considered as immutable. Although these types might match the definition of<br />
immutability, considering them as immutable would disturb developers while they<br />
care for their own immutable types.</span><span></span></li>
<li><span>Particularly,<br />
classes that derive directly or indirectly from a class defined in a tier<br />
assembly that is not the <b>System.Object</b><br />
class, is never considered as immutable.</span></li>
</ul>
<p><span>Beside the <b>IsImmutable</b> condition on types, we also added 2 conditions on<br />
methods: <b>ChangesObjectState</b> and <b>ChangesTypeState</b>. As the name suggest, <b>ChangesObjectState</b> match methods that<br />
are assigning an instance field of its class and the <b>ChangesTypeState</b> match methods that are assigning a static field of<br />
its class.</span></p>
<p><span lang="EN-GB">The condition </span><b><span>ChangesObjectState</span></b><span> </span><span lang="EN-GB">matches constructors. A static method or a class constructor can<br />
also be matched, for example, if it modifies the state of an instance passed by<br />
reference. Notice also that an instance method of a type T that modifies an<br />
instance of T that is not the one referenced by the <i>this</i> reference is<br />
also matched.</span></p>
<p><span lang="EN-GB">The condition&nbsp;<span></span></span><b><span>ChangesTypeState</span></b><span> matches </span><span lang="EN-GB">class constructor, constructors, instance methods and static methods.</span></p>
<p><span>These 2 conditions can be used to see<br />
at a glance which methods can change the state of your program, in other words,<br />
which methods are mutable or non-const, or better said, which methods provoke side-effects.<br />
And as Wes Dier wrote: <i>One way to<br />
increase the reliability of a unit is to eliminate the side-effects.</i></span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">METHODS</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>ChangesObjectState </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>!IsConstructor </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>!IsClassConstructor</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">&nbsp;</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">METHODS</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>ChangesTypeState </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>!IsConstructor </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>!IsClassConstructor </span></p>
<p><b><span>ChangesObjectState</span></b><span> can be also used as the good old C++ keyword <b>const</b> that make sure that a method won’t<br />
corrupt the object state:</span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WARN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IF</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>Count </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">!= </span><span style="background: yellow none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black">1</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">IN</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">SELECT</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">METHODS</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span></p>
<p style="margin: 0cm 0cm 0.0001pt"><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">WHERE</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>ChangesObjectState</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: blue">AND</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>FullNameIs</span><span style="background: white none repeat scroll 0% 50%;font-size: 10pt;font-family: 'Courier New';color: black"> </span><span>&#8220;MyNamespace.Foo.MyConstMethod()&#8221;</span></p>
<p><span>&nbsp;</span></p>
<p>&nbsp;</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/patricksmacchia/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a>. Bookmark the <a href="http://codebetter.com/patricksmacchia/2008/01/13/immutable-types-understand-them-and-use-them/" title="Permalink to Immutable types: understand their benefits and use them" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/patricksmacchia/2008/01/13/immutable-types-understand-them-and-use-them/feed/" title="Comments RSS to Immutable types: understand their benefits and use them" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-34 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/patricksmacchia/2008/01/05/rambling-on-the-sealed-keyword/" rel="prev"><span class="meta-nav">&larr;</span> Rambling on the sealed keyword</a></div>
					<div class="nav-next"><a href="http://codebetter.com/patricksmacchia/2008/01/20/avoid-api-breaking-changes/" rel="next">Avoid API breaking changes <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
					<li id="dsq-comment-129">
					<div id="dsq-comment-header-129" class="dsq-comment-header">
						<cite id="dsq-cite-129">
	http://www.bluespire.com/blogs							<span id="dsq-author-user-129">Christopher Bennage</span>
							</cite>
					</div>
					<div id="dsq-comment-body-129" class="dsq-comment-body">
						<div id="dsq-comment-message-129" class="dsq-comment-message"><p>Good stuff!  Thanks!</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-130">
					<div id="dsq-comment-header-130" class="dsq-comment-header">
						<cite id="dsq-cite-130">
	http://www.e-Crescendo.com							<span id="dsq-author-user-130">jdn</span>
							</cite>
					</div>
					<div id="dsq-comment-body-130" class="dsq-comment-body">
						<div id="dsq-comment-message-130" class="dsq-comment-message"><p>I&#8217;m glad you posted this as I&#8217;ve been thinking about it a bit lately.</p>
<p>Since I&#8217;m not clear on any number of things about the concept, let me ask a basic question:</p>
<p>Most of my &#8216;types&#8217; are domain objects, like Order, Customer, etc.</p>
<p>Can I apply the concept of immutability to them?  If so, how?  If not, then what does the concept of immutability bring me?</p>
<p>TIA.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-131">
					<div id="dsq-comment-header-131" class="dsq-comment-header">
						<cite id="dsq-cite-131">
	http://www.NDepend.com							<span id="dsq-author-user-131">Patrick Smacchia</span>
							</cite>
					</div>
					<div id="dsq-comment-body-131" class="dsq-comment-body">
						<div id="dsq-comment-message-131" class="dsq-comment-message"><p>TIA,</p>
<p>As explained, immutable types have numerous benefits and come at the cost of more memory consumption.<br />
There is no rule if business objects, technical objects, or any kind of other concern objects should be immutable or not. You have to evaluate case by case if it is worth it or not. Often, having some code with a lot of concurrent access is a good indication that immutability might be a good choice.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-132">
					<div id="dsq-comment-header-132" class="dsq-comment-header">
						<cite id="dsq-cite-132">
	http://codebetter.com/blogs/peter.van.ooijen/							<span id="dsq-author-user-132">pvanooijen</span>
							</cite>
					</div>
					<div id="dsq-comment-body-132" class="dsq-comment-body">
						<div id="dsq-comment-message-132" class="dsq-comment-message"><p>Perhaps nice to note in the context:<br />
Since version 3(.1?) Resharper will give you hints on fields which can be declared as readonly. With code optimization just an alt-enter away.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-133">
					<div id="dsq-comment-header-133" class="dsq-comment-header">
						<cite id="dsq-cite-133">
	http://weblogs.asp.net/bleroy							<span id="dsq-author-user-133">Bertrand Le Roy</span>
							</cite>
					</div>
					<div id="dsq-comment-body-133" class="dsq-comment-body">
						<div id="dsq-comment-message-133" class="dsq-comment-message"><p>Luca Bolognese a une très bonne série d&#8217;articles sur les types immuables:<br />
<a href="http://blogs.msdn.com/lucabol/archive/2007/12/03/creating-an-immutable-value-object-in-c-part-i-using-a-class.aspx" rel="nofollow">http://blogs.msdn.com/lucabol/archive/2007/12/03/creating-an-immutable-value-object-in-c-part-i-using-a-class.aspx</a></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-134">
					<div id="dsq-comment-header-134" class="dsq-comment-header">
						<cite id="dsq-cite-134">
								<span id="dsq-author-user-134">David Heffernan</span>
							</cite>
					</div>
					<div id="dsq-comment-body-134" class="dsq-comment-body">
						<div id="dsq-comment-message-134" class="dsq-comment-message"><p>I&#8217;m doing concurrency because I want to calculate lots of things in parallel.  I want them to change.  Immutable types don&#8217;t help concurrency much.  Sure you can prevent accidental changes to things that shouldn&#8217;t change.  Of course that&#8217;s just as valuable when coding single threaded.  I really don&#8217;t think you can have done much concurrent programming.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-135">
					<div id="dsq-comment-header-135" class="dsq-comment-header">
						<cite id="dsq-cite-135">
	http://www.NDepend.com							<span id="dsq-author-user-135">Patrick Smacchia</span>
							</cite>
					</div>
					<div id="dsq-comment-body-135" class="dsq-comment-body">
						<div id="dsq-comment-message-135" class="dsq-comment-message"><p>Of course states are changing, don&#8217;t take me wrong.</p>
<p>The idea is that when a thread is changing a state it needs to create  a new object that is not visible from other threads as in&#8230;</p>
<p>string str1 = &#8220;foofoo&#8221;;<br />
string str2 = str1.Replace(&#8220;foo&#8221;, &#8220;FOO&#8221;);</p>
<p>&#8230;the object referenced by the str2 reference is not visible from other threads and still you get your new &#8220;FOOFOO&#8221; state.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-136">
					<div id="dsq-comment-header-136" class="dsq-comment-header">
						<cite id="dsq-cite-136">
	http://www.myspace.com/yamum							<span id="dsq-author-user-136">yamum</span>
							</cite>
					</div>
					<div id="dsq-comment-body-136" class="dsq-comment-body">
						<div id="dsq-comment-message-136" class="dsq-comment-message"><p>Patrick clearly cant write a blog to save his own life.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-137">
					<div id="dsq-comment-header-137" class="dsq-comment-header">
						<cite id="dsq-cite-137">
								<span id="dsq-author-user-137">Duncan Godwin</span>
							</cite>
					</div>
					<div id="dsq-comment-body-137" class="dsq-comment-body">
						<div id="dsq-comment-message-137" class="dsq-comment-message"><p>I&#8217;m evaluating NDepend at the moment with an eye to identifying types that potentially don&#8217;t use locking correctly.  The above looks snippets look like they could save me significant time &#8211; thanks.  </p>
<p>Do you have any plans on adding direct support to help with detecting concurrency issues?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-138">
					<div id="dsq-comment-header-138" class="dsq-comment-header">
						<cite id="dsq-cite-138">
	http://opxyiea.com/yoyrryo/5.html							<span id="dsq-author-user-138">Pharmg653</span>
							</cite>
					</div>
					<div id="dsq-comment-body-138" class="dsq-comment-body">
						<div id="dsq-comment-message-138" class="dsq-comment-message"><p>Very nice site!</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-139">
					<div id="dsq-comment-header-139" class="dsq-comment-header">
						<cite id="dsq-cite-139">
	http://codebetter.com/members/ya3mro/default.aspx							<span id="dsq-author-user-139">ya3mro</span>
							</cite>
					</div>
					<div id="dsq-comment-body-139" class="dsq-comment-body">
						<div id="dsq-comment-message-139" class="dsq-comment-message"><p>thnx for this great article but i have a question about ur sentence :<br />
Hashtables are almost a magic way to enhance dramatically performance of your code. (I said magic because under the hood hashtables rely on prime numbers properties and prime numbers are magic!)</p>
<p>could u tell me what&#8217;s magic in usgin prime numbers ?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-140">
					<div id="dsq-comment-header-140" class="dsq-comment-header">
						<cite id="dsq-cite-140">
	http://javarevisited.blogspot.com							<span id="dsq-author-user-140">Javin Paul</span>
							</cite>
					</div>
					<div id="dsq-comment-body-140" class="dsq-comment-body">
						<div id="dsq-comment-message-140" class="dsq-comment-message"><p>I have compiled some reasons for String immutability,</p>
<p>See here</p>
<p><a href="http://javarevisited.blogspot.com/2010/10/why-string-is-immutable-in-java.html" rel="nofollow">http://javarevisited.blogspot.com/2010/10/why-string-is-immutable-in-java.html</a></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-141">
					<div id="dsq-comment-header-141" class="dsq-comment-header">
						<cite id="dsq-cite-141">
	http://javarevisited.blogspot.com							<span id="dsq-author-user-141">Javin Paul</span>
							</cite>
					</div>
					<div id="dsq-comment-body-141" class="dsq-comment-body">
						<div id="dsq-comment-message-141" class="dsq-comment-message"><p>good explanation ,keep posted.</p>
</div>
					</div>
				</li>
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/patricksmacchia/2008/01/13/immutable-types-understand-them-and-use-them/ ';
	var disqus_identifier = '34 /blogs/patricksmacchia/archive/2008/01/13/immutable-types-understand-them-and-use-them.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'codebetter';
	var disqus_title = "Immutable types: understand their benefits and use them";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData — fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=34');
		});
					};
	var facebookXdReceiverPath = 'http://codebetter.com/patricksmacchia/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/patricksmacchia\/2008\/01\/13\/immutable-types-understand-them-and-use-them\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter//third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.846 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-25 15:25:29 -->
<!-- super cache -->