<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>F# – Async Running with Continuation Scissors | Matthew Podwysocki</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/matthewpodwysocki/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/matthewpodwysocki/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/matthewpodwysocki/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Matthew Podwysocki' href='http://codebetter.com/matthewpodwysocki/' />
<link rel='start' title='let Matt = CodeBetter + 1' href='http://codebetter.com/matthewpodwysocki/2008/04/24/let-matt-codebetter-1/' />
<link rel='prev' title='Revisiting Memoization' href='http://codebetter.com/matthewpodwysocki/2009/06/18/revisiting-memoization/' />
<link rel='next' title='Providing Safe Alternatives' href='http://codebetter.com/matthewpodwysocki/2009/06/24/providing-safe-alternatives/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/matthewpodwysocki/2009/06/20/f-async-running-with-continuation-scissors/' />
<link rel='shortlink' href='http://codebetter.com/matthewpodwysocki/?p=151' />
<meta name="_awb_version" content="2.0.3" /><link rel="stylesheet" href="http://codebetter.com/matthewpodwysocki/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.6" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/matthewpodwysocki/disqus.css?v=2.0" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/matthewpodwysocki/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-151" class="post-151 post type-post status-publish format-standard hentry category-concurrency category-f category-functional-programming">
					<h1 class="entry-title">F# – Async Running with Continuation Scissors</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/matthewpodwysocki/author/matthewpodwysocki/" title="View all posts by matthewpodwysocki">matthewpodwysocki</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/matthewpodwysocki/2009/06/20/f-async-running-with-continuation-scissors/" title="6:04 am" rel="bookmark"><span class="entry-date">June 20, 2009</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/matthewpodwysocki/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/matthewpodwysocki/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/matthewpodwysocki/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>As you may have noticed, I’ve been covering a bit about concurrency on this blog lately, and for good reason.&#160; Between Axum, Erlang, Scala and F#, there is a lot to explore with actor model concurrency, task based concurrency, data parallel applications and so on.&#160; In the next couple of months, I have some talks coming up on concurrency and in particular with F#.&#160; I’ve been covering a bit of that with F# and mailbox processing, but I wanted to step back a bit into the asynchronous workflows and hitting against a well known API.&#160; </p>
<p>In this case, let’s walk through a simple example of using the <a href="http://apiwiki.twitter.com/Twitter-API-Documentation">Twitter HTTP API</a> to get a user timeline using F# asynchronous workflows.&#160; Best of all, I’ve done all of the above code without ever once opening up Visual Studio and instead using the power of a simple text editor and F# interactive, I’m able to be quite productive.&#160; It certainly makes me rethink my utter dependence on certain tools…</p>
<h2>Give me some tweets… eventually, when you get around to it</h2>
<p>In order to get started, we need some helpers when dealing with LINQ to XML.&#160; <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2009/06/11/f-duck-typing-and-structural-typing.aspx">In a previous post</a>, I talked about the need for such a thing due to the lack of implicit operator support in F#.&#160; We can use the same operator that we had before such as the following:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> </span><span style="color: #0000FF">inline</span><span style="color: #000000"> implicit arg </span><span style="color: #000000">=</span><span style="color: #000000">
    (</span><span style="color: #000000">^</span><span style="color: #000000">a : (</span><span style="color: #0000FF">static</span><span style="color: #000000"> </span><span style="color: #0000FF">member</span><span style="color: #000000"> op_Implicit : </span><span style="color: #000000">^</span><span style="color: #000000">b </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> </span><span style="color: #000000">^</span><span style="color: #000000">a) arg)

</span><span style="color: #0000FF">let</span><span style="color: #000000"> (</span><span style="color: #000000">!!</span><span style="color: #000000">) : string </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> XName </span><span style="color: #000000">=</span><span style="color: #000000"> implicit</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Alternatively, we could look at utilizing the XNamespace as well due to it also having an implicit operator to convert from a string.&#160; This is helpful as it has a defined the op_Addition which allows us to add an XNamespace to a string to create an XName.&#160; To take advantage we could add an additional operator to take care of this.&#160; Below is a simple session of F# interactive to show how it might work:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">&gt;</span><span style="color: #000000"> </span><span style="color: #0000FF">let</span><span style="color: #000000"> (</span><span style="color: #000000">!?</span><span style="color: #000000">) : string </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> XNamespace </span><span style="color: #000000">=</span><span style="color: #000000"> implicit;;
</span><span style="color: #0000FF">val</span><span style="color: #000000"> ( </span><span style="color: #000000">!?</span><span style="color: #000000"> ) : (string </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> XNamespace)

</span><span style="color: #000000">&gt;</span><span style="color: #000000"> (</span><span style="color: #000000">+</span><span style="color: #000000">) </span><span style="color: #000000">!?</span><span style="color: #800000">""</span><span style="color: #000000">;;
</span><span style="color: #0000FF">val</span><span style="color: #000000"> it : (string </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> XName) </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">&lt;</span><span style="color: #0000FF">fun</span><span style="color: #000000">:it@</span><span style="color: #800080">205</span><span style="color: #000000">&gt;</span><span style="color: #000000">

</span><span style="color: #000000">&gt;</span><span style="color: #000000"> </span><span style="color: #000000">!?</span><span style="color: #800000">""</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">foo</span><span style="color: #800000">"</span><span style="color: #000000">;;
</span><span style="color: #0000FF">val</span><span style="color: #000000"> it : XName </span><span style="color: #000000">=</span><span style="color: #000000"> foo {LocalName </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">foo</span><span style="color: #800000">"</span><span style="color: #000000">;
                      Namespace </span><span style="color: #000000">=</span><span style="color: #000000"> ;
                      NamespaceName </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">""</span><span style="color: #000000">;}</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>If you’ll notice above, I curried the XNamespace implicit operator function and sure enough it recognizes it needs a string in order to produce an XName.&#160; Now that we’ve defined our helpers, let’s start looking at how to get a user’s timeline in Twitter.&#160; We’ll need to define a holder for our status data as well as the URL we will be using to post data.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">type</span><span style="color: #000000"> UserStatus </span><span style="color: #000000">=</span><span style="color: #000000"> { UserName : string; ProfileImage : string; Status : string; StatusDate : DateTime }

</span><span style="color: #0000FF">let</span><span style="color: #000000"> timelineUrl </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">http://twitter.com/statuses/friends_timeline.xml</span><span style="color: #800000">"</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>We’re interested at this point just of the user name, their image file location, their status and the date of the tweet.&#160; Now let’s move onto retrieving and parsing the data.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> parseDocument xml </span><span style="color: #000000">=</span><span style="color: #000000">
  </span><span style="color: #0000FF">let</span><span style="color: #000000"> document </span><span style="color: #000000">=</span><span style="color: #000000"> XDocument.Parse(xml)
  document.Root.Descendants()
    </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> Seq.choose(</span><span style="color: #0000FF">fun</span><span style="color: #000000"> node </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">
         </span><span style="color: #0000FF">if</span><span style="color: #000000"> node.Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">user</span><span style="color: #800000">"</span><span style="color: #000000">) </span><span style="color: #000000">&lt;&gt;</span><span style="color: #000000"> </span><span style="color: #0000FF">null</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span><span style="color: #000000">
           </span><span style="color: #0000FF">let</span><span style="color: #000000"> status </span><span style="color: #000000">=</span><span style="color: #000000"> HttpUtility.HtmlDecode(node.Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">text</span><span style="color: #800000">"</span><span style="color: #000000">).Value)
           </span><span style="color: #0000FF">let</span><span style="color: #000000"> image </span><span style="color: #000000">=</span><span style="color: #000000"> node.Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">user</span><span style="color: #800000">"</span><span style="color: #000000">).Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">profile_image_url</span><span style="color: #800000">"</span><span style="color: #000000">).Value
           </span><span style="color: #0000FF">let</span><span style="color: #000000"> userName </span><span style="color: #000000">=</span><span style="color: #000000"> node.Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">user</span><span style="color: #800000">"</span><span style="color: #000000">).Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">screen_name</span><span style="color: #800000">"</span><span style="color: #000000">).Value
           </span><span style="color: #0000FF">let</span><span style="color: #000000"> statusDate </span><span style="color: #000000">=</span><span style="color: #000000"> DateTime.ParseExact(node.Element(</span><span style="color: #000000">!!</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">created_at</span><span style="color: #800000">"</span><span style="color: #000000">).Value,
                                                </span><span style="color: #800000">"</span><span style="color: #800000">ddd MMM dd HH:mm:ss +0000 yyyy</span><span style="color: #800000">"</span><span style="color: #000000">,
                                                CultureInfo.CurrentCulture)
           Some { UserName </span><span style="color: #000000">=</span><span style="color: #000000"> userName; ProfileImage </span><span style="color: #000000">=</span><span style="color: #000000"> image; Status </span><span style="color: #000000">=</span><span style="color: #000000"> status; StatusDate </span><span style="color: #000000">=</span><span style="color: #000000"> statusDate}
         </span><span style="color: #0000FF">else</span><span style="color: #000000"> None)  

</span><span style="color: #0000FF">let</span><span style="color: #000000"> getUserTimeline userName password </span><span style="color: #000000">=</span><span style="color: #000000">
  async { </span><span style="color: #0000FF">let</span><span style="color: #000000"> request </span><span style="color: #000000">=</span><span style="color: #000000"> WebRequest.Create timelineUrl :</span><span style="color: #000000">?&gt;</span><span style="color: #000000"> HttpWebRequest
          </span><span style="color: #0000FF">do</span><span style="color: #000000"> request.Credentials </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> NetworkCredential(userName, password)

          </span><span style="color: #0000FF">use</span><span style="color: #000000">!</span><span style="color: #000000"> response </span><span style="color: #000000">=</span><span style="color: #000000"> request.AsyncGetResponse()
          </span><span style="color: #0000FF">use</span><span style="color: #000000"> reader </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> StreamReader(response.GetResponseStream())
          </span><span style="color: #0000FF">let</span><span style="color: #000000">!</span><span style="color: #000000"> xml </span><span style="color: #000000">=</span><span style="color: #000000"> reader.AsyncReadToEnd()

          </span><span style="color: #0000FF">return</span><span style="color: #000000"> parseDocument xml
        }</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>In the above code, we create a WebRequest, setting the credentials through Basic Authentication.&#160; We’ll cover this approach for now with some attention to OAuth at some point in the relative near future.&#160; After setting the identity, we get the response stream and read it to the end.&#160; This gives us XML to parse and by using LINQ to XML, we’re able to iterate through each node, and if the user node is not null then we parse out each element for which we’re concerned.</p>
<p>Now that we have the ability to do some asynchronous behavior, what do we do about it?&#160; In previous posts, I’ve taken the road of running these operations in parallel, which then runs all instances and returns an answer.&#160; But, if we’re&#160; only executing one instance, how do we enlist in asynchronous behavior overall?&#160; To illustrate, I’ll create a simple Windows Forms application to display the tweets in a textbox and have a refresh button to call the above function to repopulate our textbox.&#160; First, let’s create the basic skeleton:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> form </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> Form(Visible</span><span style="color: #000000">=</span><span style="color: #0000FF">true</span><span style="color: #000000">, TopMost </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">true</span><span style="color: #000000">, Width</span><span style="color: #000000">=</span><span style="color: #800080">500</span><span style="color: #000000">, Height</span><span style="color: #000000">=</span><span style="color: #800080">300</span><span style="color: #000000">)

</span><span style="color: #0000FF">let</span><span style="color: #000000"> status </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> TextBox(Multiline</span><span style="color: #000000">=</span><span style="color: #0000FF">true</span><span style="color: #000000">, ScrollBars</span><span style="color: #000000">=</span><span style="color: #000000">ScrollBars.Vertical)
form.Controls.Add status
status.Width </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800080">400</span><span style="color: #000000">
status.Height </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800080">300</span><span style="color: #000000">

</span><span style="color: #0000FF">let</span><span style="color: #000000"> refresh </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> Button(Text</span><span style="color: #000000">=</span><span style="color: #800000">"</span><span style="color: #800000">Refresh</span><span style="color: #800000">"</span><span style="color: #000000">)
form.Controls.Add refresh
refresh.Left </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800080">410</span><span style="color: #000000">
refresh.Top </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800080">10</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Now that we have a basic skeleton, let’s add the behavior to the button to refresh our textbox.&#160; To do this, we simply add a handler to the button click event.&#160; In there, we will call Async.RunWithContinuations which gives us the ability to handle not only the successful case, but also should an exception be thrown or some form of cancelation occurs.&#160; Before we look at the implementing code, let’s look at the signature of RunWithContinuations:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">&gt;</span><span style="color: #000000"> Async.RunWithContinuations;;
</span><span style="color: #0000FF">val</span><span style="color: #000000"> it :
  (</span><span style="color: #800000">'</span><span style="color: #800000">a -&gt; unit) * (exn -&gt; unit) * (OperationCanceledException -&gt; unit) *</span><span style="color: #800000">
</span><span style="color: #000000">  Async</span><span style="color: #000000">&lt;</span><span style="color: #800000">'</span><span style="color: #800000">a&gt; -&gt; unit = &lt;fun:clo@0-42&gt;</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>What this tells us is that it takes a success continuation as the first argument, the exception continuation as the second argument, the cancelation continuation as the third, and then finally the asynchronous operation.&#160; This allows us to uniquely handle each type of event, should they occur.&#160; In this case, our success continuation should populate the textbox, whereas both the cancelation and the exceptional case should show a message box containing the exception.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">refresh.Click.Add
   (</span><span style="color: #0000FF">fun</span><span style="color: #000000"> args </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">
      status.Text </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800000">""</span><span style="color: #000000">
      Async.RunWithContinuations(
        (</span><span style="color: #0000FF">fun</span><span style="color: #000000"> res </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">
           res </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> Seq.iter(</span><span style="color: #0000FF">fun</span><span style="color: #000000"> item </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> status.Text </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> sprintf </span><span style="color: #800000">"</span><span style="color: #800000">User: %s - %s\r\n\r\n%s</span><span style="color: #800000">"</span><span style="color: #000000"> item.UserName item.Status status.Text )),
        (</span><span style="color: #0000FF">fun</span><span style="color: #000000"> exn </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> MessageBox.Show(sprintf </span><span style="color: #800000">"</span><span style="color: #800000">An error occurred: %A</span><span style="color: #800000">"</span><span style="color: #000000"> exn) </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> ignore),
        (</span><span style="color: #0000FF">fun</span><span style="color: #000000"> cxn </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> MessageBox.Show(sprintf </span><span style="color: #800000">"</span><span style="color: #800000">A cancellation error ocurred: %A</span><span style="color: #800000">"</span><span style="color: #000000"> cxn) </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> ignore),
        (getUserTimeline </span><span style="color: #800000">"</span><span style="color: #800000">username</span><span style="color: #800000">"</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">password</span><span style="color: #800000">"</span><span style="color: #000000">)))</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p> As you can see, the behavior is rather straight forward to define handlers for our three cases.&#160; Lastly, we provide our credentials to the getUserTimeline function and then when the button is clicked, we’ll get results much like the following screenshot.</p>
<p><a href="http://codebetter.com/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/matthew.podwysocki/image_5F00_07355EFB.png"><img style="border-right-width: 0px;border-top-width: 0px;border-bottom-width: 0px;border-left-width: 0px" border="0" alt="image" src="http://s3.amazonaws.com:80/CodeBetter/CommunityServer.Blogs.Components.WeblogFiles/matthew/podwysocki/image_thumb_4626DF96.png?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1919787602&amp;Signature=GggfGT8MqCwDgd2Mhxk9h7LEyZ4%3d" width="461" height="259" /></a> </p>
<p> Then we can keep pressing the refresh button and then asynchronously, it will handle the behavior appropriately, either in success or in failure.&#160;&#160; </p>
<h2>Conclusion</h2>
<p>This is a pretty simply and naive application, but it can show how you can take advantage of asynchronous behavior using the Async Workflows in F#.&#160; By being able to have the F# libraries handle the exceptions and cancelation, a major source of errors is reduced by quite a bit.&#160; Giving us the power then to handle each one of these scenarios, either in success, failure or cancelation is a great concept.&#160; There is still more yet to be covered including Futures and the inclusion of the Task Parallel Library as well as other adventures into Twitter and Bing APIs.</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/matthewpodwysocki/category/concurrency/" title="View all posts in Concurrency" rel="category tag">Concurrency</a>, <a href="http://codebetter.com/matthewpodwysocki/category/f/" title="View all posts in F#" rel="category tag">F#</a>, <a href="http://codebetter.com/matthewpodwysocki/category/functional-programming/" title="View all posts in Functional Programming" rel="category tag">Functional Programming</a>. Bookmark the <a href="http://codebetter.com/matthewpodwysocki/2009/06/20/f-async-running-with-continuation-scissors/" title="Permalink to F# – Async Running with Continuation Scissors" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/matthewpodwysocki/2009/06/20/f-async-running-with-continuation-scissors/feed/" title="Comments RSS to F# – Async Running with Continuation Scissors" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-151 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/matthewpodwysocki/2009/06/18/revisiting-memoization/" rel="prev"><span class="meta-nav">&larr;</span> Revisiting Memoization</a></div>
					<div class="nav-next"><a href="http://codebetter.com/matthewpodwysocki/2009/06/24/providing-safe-alternatives/" rel="next">Providing Safe Alternatives <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/matthewpodwysocki/2009/06/20/f-async-running-with-continuation-scissors/ ';
	var disqus_identifier = '151 /blogs/matthew.podwysocki/archive/2009/06/20/f-async-running-with-continuation-scissors.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'matthewpodwysocki';
	var disqus_title = "F# – Async Running with Continuation Scissors";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData — fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=151');
		});
					};
	var facebookXdReceiverPath = 'http://codebetter.com/matthewpodwysocki/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/matthewpodwysocki\/2009\/06\/20\/f-async-running-with-continuation-scissors\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter//third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.889 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-24 20:10:40 -->
<!-- super cache -->