<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Functional .NET – Laziness Becomes You | Matthew Podwysocki</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/matthewpodwysocki/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/matthewpodwysocki/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/matthewpodwysocki/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Matthew Podwysocki' href='http://codebetter.com/matthewpodwysocki/' />
<link rel='start' title='let Matt = CodeBetter + 1' href='http://codebetter.com/matthewpodwysocki/2008/04/24/let-matt-codebetter-1/' />
<link rel='prev' title='Functional Programming in .NET – Adding Extensibility' href='http://codebetter.com/matthewpodwysocki/2009/03/14/functional-programming-in-net-adding-extensibility/' />
<link rel='next' title='Functional .NET – Lose the Magic Strings' href='http://codebetter.com/matthewpodwysocki/2009/03/19/functional-net-lose-the-magic-strings/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/matthewpodwysocki/2009/03/18/functional-net-laziness-becomes-you/' />
<link rel='shortlink' href='http://codebetter.com/matthewpodwysocki/?p=118' />
<link rel="stylesheet" href="http://codebetter.com/matthewpodwysocki/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/matthewpodwysocki/disqus.css?v=2.0" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/matthewpodwysocki/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-118" class="post-118 post type-post status-publish format-standard hentry category-c category-f category-functional-programming category-haskell">
					<h1 class="entry-title">Functional .NET – Laziness Becomes You</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/matthewpodwysocki/author/matthewpodwysocki/" title="View all posts by matthewpodwysocki">matthewpodwysocki</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/matthewpodwysocki/2009/03/18/functional-net-laziness-becomes-you/" title="6:04 am" rel="bookmark"><span class="entry-date">March 18, 2009</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/matthewpodwysocki/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/matthewpodwysocki/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/matthewpodwysocki/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>In the previous post, I talked about some of the basic ideas you can learn from Functional Programming and apply to your code right now.&#160; The first topic that was tackled was <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2009/03/14/functional-programming-in-net-adding-extensibility.aspx">extensibility through the use of closures</a>.&#160; Today, I’ll cover laziness in your APIs, how it can help, and what pitfalls might arise.</p>
<h2>Laziness Explained</h2>
<p>One of the hallmark features of the Haskell programming language is lazy evaluation.&#160; This gives us the ability to delay the computation of a given function, structure, etc, until it is absolutely needed.&#160; Sounds very agile in a way of the last responsible moment, actually.&#160; Why is it useful?&#160; By delaying the computation, we can gain performance increases by avoiding the calculations ahead of time.&#160; With this, we can create infinite data structures, as well as control structures such as if/then/else statements.&#160; Let’s take two Haskell examples of infinite structures, the first being an infinite list of 1 to whatever, and the next of all, yes, I know, the trite Fibonacci sequence.&#160; Opening up the GHCi, we can type along:</p>
<div style="font-family: courier new">Prelude&gt; let l = [1..]&#160; <span style="color: green">&#8211;</span> Infinite list from 1 to beyond     <br />Prelude&gt; take 3 l     <br />[1,2,3]     <br />Prelude&gt; let fibs = 0 : 1 : zipWith (+) fibs (tail fibs)     <br />Prelude&gt; :t fibs <span style="color: green">&#8211;</span> All Fibonacci numbers     <br />fibs :: [Integer]     <br />Prelude&gt; take 5 fibs     <br />[0,1,1,2,3]     </div>
<p>I find when explaining some of these topics, that Haskell as a language works best.&#160; The Fibonacci sequence is calculated with a cons of 0 and then a cons of 1 to the zipWith of addition of the Fibonacci sequence and the tail of the Fibonacci sequence.&#160; This takes the initial cons and then takes the previous (the tail) and the current and adds them together in an even/odd fashion.&#160; But the important thing to note is that even though the list goes on forever, evaluating this didn’t cause my system to crash.&#160; </p>
<p>Just as well, we could rewrite the following in F# pretty much the same as above with a few changes.&#160; The sequence comprehensions do not understand infinite sequences, so we can use other means as well.&#160; And since F# is an eagerly evaluated language, we’ll have to use a thunk to express the laziness.&#160; We’ll get into what that is a little later below:</p>
<div style="font-family: courier new"><span style="color: green">// Infinite sequence</span>     <br />&gt; <span style="color: blue">let</span> l = Seq<span style="color: blue">.</span>init_infinite id;;     <br /><span style="color: blue">val</span> l <span style="color: blue">:</span> seq&lt;<span style="color: blue">int</span>&gt;     <br />&gt; Seq<span style="color: blue">.</span>take <span style="color: maroon">3</span> l;;     <br /><span style="color: blue">val</span> it <span style="color: blue">:</span> seq&lt;<span style="color: blue">int</span>&gt; = seq <span style="color: blue">[</span><span style="color: maroon">0</span>; <span style="color: maroon">1</span>; <span style="color: maroon">2</span><span style="color: blue">]</span>     </p>
<p><span style="color: green">// Fibonacci with map2</span>     <br />&gt; <span style="color: blue">#r</span>&#160;<span style="color: maroon">&quot;FSharp.PowerPack.dll&quot;</span>;;     <br />&gt; <span style="color: blue">let</span>&#160;<span style="color: blue">rec</span> fibs <span style="color: blue">:</span> LazyList&lt;<span style="color: blue">int</span>&gt; =     <br />-&#160;&#160; LazyList<span style="color: blue">.</span>consf <span style="color: maroon">0</span>&#160; <br />-&#160;&#160;&#160;&#160; <span style="color: blue">(</span><span style="color: blue">fun</span>&#160;<span style="color: blue">(</span><span style="color: blue">)</span>&#160;<span style="color: blue">-&gt;</span>&#160;<span style="color: blue">(</span>LazyList<span style="color: blue">.</span>cons <span style="color: maroon">1</span>&#160; <br />-&#160;&#160;&#160;&#160; <span style="color: blue">(</span>LazyList<span style="color: blue">.</span>map2 <span style="color: blue">(</span>+<span style="color: blue">)</span> fibs <span style="color: blue">(</span>LazyList<span style="color: blue">.</span>tl fibs<span style="color: blue">)</span><span style="color: blue">)</span><span style="color: blue">)</span><span style="color: blue">)</span>;;     <br /><span style="color: blue">val</span> fibs <span style="color: blue">:</span> LazyList&lt;<span style="color: blue">int</span>&gt;     <br />&gt; Seq<span style="color: blue">.</span>take <span style="color: maroon">3</span> fibs;;     <br /><span style="color: blue">val</span> it <span style="color: blue">:</span> seq&lt;<span style="color: blue">int</span>&gt; = seq <span style="color: blue">[</span><span style="color: maroon">0</span>; <span style="color: maroon">1</span>; <span style="color: maroon">1</span><span style="color: blue">]</span>     </div>
<p>But another use could be the control statements of if/then/else as a simple example.&#160; Imagine if you will that you were implementing this as a function instead of as a language feature.&#160; The last thing you’d want to do is eagerly evaluate the else statement before its needed, else it could cause some unwanted side effects or even possibly crash.&#160; </p>
<p>There are some really good articles on the Haskell Wiki on <a href="http://www.haskell.org/haskellwiki/Haskell/Lazy_evaluation">how laziness works</a> and the <a href="http://www.haskell.org/haskellwiki/Performance/Laziness">performance metrics</a> that you can check out as well.&#160; As much as I love talking about Haskell, let’s move onto .NET and talk a little about where it can fit there as well.</p>
<h2>How Lazy Is .NET Anyways?</h2>
<p>So, the question becomes, just how lazy can .NET be?&#160; Well, there are several pieces to cover, including iterators, delayed evaluation through functions and lazy values, of which the latter will be covered in a later post.</p>
<h2>Iterators</h2>
<p>With the advent of iterators in C# 2.0 and the ability to yield values on an as needed basis through the use of continuations.&#160; For example, we could rewrite the fibs sequence using a C# 2.0 iterator such as this:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">static</span><span style="color: #000000"> IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">ulong</span><span style="color: #000000">&gt;</span><span style="color: #000000"> Fibonacci
{
    </span><span style="color: #0000FF">get</span><span style="color: #000000">
    {
        </span><span style="color: #0000FF">ulong</span><span style="color: #000000"> i </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800080">1</span><span style="color: #000000">;
        </span><span style="color: #0000FF">ulong</span><span style="color: #000000"> j </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800080">1</span><span style="color: #000000">;
        </span><span style="color: #0000FF">while</span><span style="color: #000000"> (</span><span style="color: #0000FF">true</span><span style="color: #000000">)
        {
            </span><span style="color: #0000FF">yield</span><span style="color: #000000"> </span><span style="color: #0000FF">return</span><span style="color: #000000"> i;
            var temp </span><span style="color: #000000">=</span><span style="color: #000000"> i;
            i </span><span style="color: #000000">=</span><span style="color: #000000"> j;
            j </span><span style="color: #000000">=</span><span style="color: #000000"> j </span><span style="color: #000000">+</span><span style="color: #000000"> temp;
        }
    }
}</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>With this, we’re able to calculate every number as we want them and nothing beforehand.&#160; If you step through the code, you’ll see how it operates.&#160; But, moving on, we can also use this to express API calls that are right now, thoroughly eager.&#160; Take for example, the Directory.GetFiles method which takes a path and some options, and returns a string array of the file names.&#160; The problem with that is that you could be traversing a directory of thousands of images or documents, and is there a need at that point to evaluate all of them, when you may only want the top 5?</p>
<p>In a previous post, “Functional .NET – Fighting Friction in the BCL”, I did exactly that to implement the Directory.GetFiles in a lazy evaluated manner.&#160; The underlying Kernel32 implementations in Windows use an iterator pattern of FindFIrstFile and FindNextFile of which we can easily take advantage.&#160; Let’s once again look at the example:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">static</span><span style="color: #000000"> IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">&gt;</span><span style="color: #000000"> GetFiles(
    </span><span style="color: #0000FF">string</span><span style="color: #000000"> directory,
    SearchOption option)
{
    var findData </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> NativeMethods.WIN32_FIND_DATA();
    </span><span style="color: #0000FF">using</span><span style="color: #000000"> (var findHandle </span><span style="color: #000000">=</span><span style="color: #000000"> NativeMethods.FindFirstFile(
        directory </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #800000">@"</span><span style="color: #800000">\*</span><span style="color: #800000">"</span><span style="color: #000000">, findData))
    {
        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #000000">!</span><span style="color: #000000">findHandle.IsInvalid)
        {
            </span><span style="color: #0000FF">do</span><span style="color: #000000">
            {
                </span><span style="color: #0000FF">if</span><span style="color: #000000"> ((findData.dwFileAttributes </span><span style="color: #000000">&amp;</span><span style="color: #000000">
                    FileAttributes.Directory) </span><span style="color: #000000">!=</span><span style="color: #000000"> </span><span style="color: #800080">0</span><span style="color: #000000">)
                {
                    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (findData.cFileName </span><span style="color: #000000">!=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">.</span><span style="color: #800000">"</span><span style="color: #000000"> </span><span style="color: #000000">&amp;&amp;</span><span style="color: #000000">
                        findData.cFileName </span><span style="color: #000000">!=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">..</span><span style="color: #800000">"</span><span style="color: #000000">)
                    {
                        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (option </span><span style="color: #000000">==</span><span style="color: #000000"> SearchOption.AllDirectories)
                        {
                            var subdirectory </span><span style="color: #000000">=</span><span style="color: #000000"> Path.Combine(
                                directory,
                                findData.cFileName);
                            </span><span style="color: #0000FF">foreach</span><span style="color: #000000"> (var file </span><span style="color: #0000FF">in</span><span style="color: #000000"> GetFiles(subdirectory, option))
                                </span><span style="color: #0000FF">yield</span><span style="color: #000000"> </span><span style="color: #0000FF">return</span><span style="color: #000000"> file;
                        }
                    }
                }
                </span><span style="color: #0000FF">else</span><span style="color: #000000">
                {
                    var filePath </span><span style="color: #000000">=</span><span style="color: #000000"> Path.Combine(directory, findData.cFileName);
                    </span><span style="color: #0000FF">yield</span><span style="color: #000000"> </span><span style="color: #0000FF">return</span><span style="color: #000000"> filePath;
                }
            } </span><span style="color: #0000FF">while</span><span style="color: #000000"> (NativeMethods.FindNextFile(findHandle, findData));
        }
    }
} </span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Now, through the power of LINQ, we are able to pick and choose what type of file we want and how many we want at the same time.&#160; Such examples might be:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">var fiveFiles </span><span style="color: #000000">=</span><span style="color: #000000"> GetFiles(</span><span style="color: #800000">@"</span><span style="color: #800000">C:\Work</span><span style="color: #800000">"</span><span style="color: #000000">).Take(</span><span style="color: #800080">5</span><span style="color: #000000">);

var results </span><span style="color: #000000">=</span><span style="color: #000000"> from file </span><span style="color: #0000FF">in</span><span style="color: #000000"> GetFiles(</span><span style="color: #800000">@"</span><span style="color: #800000">C:\Tools</span><span style="color: #800000">"</span><span style="color: #000000">, SearchOption.AllDirectories)
              </span><span style="color: #0000FF">where</span><span style="color: #000000"> (File.GetAttributes(file) </span><span style="color: #000000">&amp;</span><span style="color: #000000"> FileAttributes.Hidden) </span><span style="color: #000000">!=</span><span style="color: #000000"> </span><span style="color: #800080">0</span><span style="color: #000000">
              select </span><span style="color: #0000FF">new</span><span style="color: #000000"> FileInfo(file);</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Well, that’s all very good and interesting.&#160; But what about another idea of delaying evaluation with functions?</p>
<h2>Thunking About It</h2>
<p>Another way of delaying the execution of a given statement is by wrapping it in a function.&#160; This is called a <a href="http://en.wikipedia.org/wiki/Thunk">thunk</a>, which is a function which takes no arguments and delays the computation of the function return value.&#160; The function returned forces the thunk then to obtain the actual value.&#160; The reason for doing so is once again as above to not compute until absolutely needed.&#160; Such scenarios for this could be the initialization of a container or some other potentially expensive operation.&#160; </p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">static</span><span style="color: #000000"> Func</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">double</span><span style="color: #000000">&gt;</span><span style="color: #000000"> Average(IEnumerable</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">int</span><span style="color: #000000">&gt;</span><span style="color: #000000"> items)
{
    </span><span style="color: #0000FF">return</span><span style="color: #000000"> () </span><span style="color: #000000">=&gt;</span><span style="color: #000000"> items.Average();
}</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>This in itself is interesting in that we get a function back at which point we are free to evaluate it when it’s absolutely needed.&#160; We can also write a version of the </p>
<p>Is anybody using this in practice though?&#160; The answer is yes!</p>
<p>The <a href="http://www.codeplex.com/CommonServiceLocator">Common Service Locator library</a> on CodePlex has a very good example of using this in practice.&#160; For example, when we want to register the <a href="http://structuremap.sourceforge.net/Default.htm">StructureMap</a> container, here is the following code used:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">var container </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> Container(x </span><span style="color: #000000">=&gt;</span><span style="color: #000000">
    x.ForRequestedType</span><span style="color: #000000">&lt;</span><span style="color: #000000">ICustomerRepository</span><span style="color: #000000">&gt;</span><span style="color: #000000">()
    .TheDefaultIsConcreteType</span><span style="color: #000000">&lt;</span><span style="color: #000000">CustomerRepository</span><span style="color: #000000">&gt;</span><span style="color: #000000">());

ServiceLocator.SetLocatorProvider(
    () </span><span style="color: #000000">=&gt;</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> StructureMapServiceLocator(container));  </span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>If we look at the actual implementation in the source code, we find we set our thunk in the SetLocatorProvider and then only force the eval once you call the Current property as follows with the comments being my own:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">static</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> ServiceLocator
{
    </span><span style="color: #008000">//</span><span style="color: #008000"> The thunk
    </span><span style="color: #008000">//</span><span style="color: #008000"> Should be just Func&lt;IServiceLocator&gt; instead</span><span style="color: #008000">
</span><span style="color: #000000">    </span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #0000FF">static</span><span style="color: #000000"> ServiceLocatorProvider currentProvider;

    </span><span style="color: #008000">//</span><span style="color: #008000"> Force the eval</span><span style="color: #008000">
</span><span style="color: #000000">    </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">static</span><span style="color: #000000"> IServiceLocator Current
    {
        </span><span style="color: #0000FF">get</span><span style="color: #000000"> { </span><span style="color: #0000FF">return</span><span style="color: #000000"> currentProvider(); }
    }

    </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">static</span><span style="color: #000000"> </span><span style="color: #0000FF">void</span><span style="color: #000000"> SetLocatorProvider(ServiceLocatorProvider newProvider)
    {
        currentProvider </span><span style="color: #000000">=</span><span style="color: #000000"> newProvider;
    }
}</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Pretty straight forward, and yet a powerful concept.&#160; </p>
<h2>Side Effects and Laziness</h2>
<p>Laziness in your APIs can be a good thing.&#160; But with this good thing, there are downfalls that some beginners can make.&#160; I noted back in September of last year some of these pitfalls in my post <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2008/09/12/side-effects-and-functional-programming.aspx">“Side Effects and Functional Programming”</a>.&#160; In this post, I covered a couple of cases including:</p>
<ul>
<li>Order of Side Effects with Laziness </li>
<li>Exception Management </li>
<li>Resource Management </li>
<li>Closure scope </li>
</ul>
<p>These are important to keep in mind as we’re mixing paradigms because laziness and side effects don’t mix.&#160; Alas, many do say that Haskell has been harder for them to pick up in part due to the lazy evaluation.&#160; </p>
<h2>Conclusion</h2>
<p>With just these two examples of iterators and thunks, we have some ideas on how we can apply laziness to our codebase, with some careful consideration of side effects of course.&#160; There are yet many other cases to cover in this area, but I think for now this is a good starting point.&#160; Other areas yet to explore with how to improve your code with functional constructs yet to come is around the use of expressions and functions to rid yourselves of the evil “magic strings”.</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/matthewpodwysocki/category/c/" title="View all posts in C#" rel="category tag">C#</a>, <a href="http://codebetter.com/matthewpodwysocki/category/f/" title="View all posts in F#" rel="category tag">F#</a>, <a href="http://codebetter.com/matthewpodwysocki/category/functional-programming/" title="View all posts in Functional Programming" rel="category tag">Functional Programming</a>, <a href="http://codebetter.com/matthewpodwysocki/category/haskell/" title="View all posts in Haskell" rel="category tag">Haskell</a>. Bookmark the <a href="http://codebetter.com/matthewpodwysocki/2009/03/18/functional-net-laziness-becomes-you/" title="Permalink to Functional .NET – Laziness Becomes You" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/matthewpodwysocki/2009/03/18/functional-net-laziness-becomes-you/feed/" title="Comments RSS to Functional .NET – Laziness Becomes You" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-118 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/matthewpodwysocki/2009/03/14/functional-programming-in-net-adding-extensibility/" rel="prev"><span class="meta-nav">&larr;</span> Functional Programming in .NET – Adding Extensibility</a></div>
					<div class="nav-next"><a href="http://codebetter.com/matthewpodwysocki/2009/03/19/functional-net-lose-the-magic-strings/" rel="next">Functional .NET – Lose the Magic Strings <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/matthewpodwysocki/2009/03/18/functional-net-laziness-becomes-you/ ';
	var disqus_identifier = '118 /blogs/matthew.podwysocki/archive/2009/03/18/functional-net-laziness-becomes-you.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'matthewpodwysocki';
	var disqus_title = "Functional .NET – Laziness Becomes You";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData — fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=118');
		});
					};
	var facebookXdReceiverPath = 'http://codebetter.com/matthewpodwysocki/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/matthewpodwysocki\/2009\/03\/18\/functional-net-laziness-becomes-you\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.258 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-27 10:13:24 -->
<!-- super cache -->