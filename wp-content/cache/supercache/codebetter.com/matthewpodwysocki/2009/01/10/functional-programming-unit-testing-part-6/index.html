<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Functional Programming Unit Testing &#8211; Part 6 | Matthew Podwysocki</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://cdn1.codebetter.com/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Matthew Podwysocki' href='http://codebetter.com/matthewpodwysocki/' />
<link rel='start' title='let Matt = CodeBetter + 1' href='http://codebetter.com/matthewpodwysocki/2008/04/24/let-matt-codebetter-1/' />
<link rel='prev' title='2008 – The Year that Was' href='http://codebetter.com/matthewpodwysocki/2009/01/05/2008-the-year-that-was/' />
<link rel='next' title='How would the CLR Be Different?' href='http://codebetter.com/matthewpodwysocki/2009/01/13/how-would-the-clr-be-different/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/matthewpodwysocki/2009/01/10/functional-programming-unit-testing-part-6/' />
<link rel='shortlink' href='http://codebetter.com/matthewpodwysocki/?p=100' />
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/matthewpodwysocki/disqus.css?v=2.0" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-100" class="post-100 post type-post status-publish format-standard hentry category-f category-functional-programming category-haskell category-tddbdd">
					<h1 class="entry-title">Functional Programming Unit Testing &#8211; Part 6</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/matthewpodwysocki/author/matthewpodwysocki/" title="View all posts by matthewpodwysocki">matthewpodwysocki</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/matthewpodwysocki/2009/01/10/functional-programming-unit-testing-part-6/" title="8:58 pm" rel="bookmark"><span class="entry-date">January 10, 2009</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/matthewpodwysocki/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/matthewpodwysocki/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>In the last installment in this series, we talked about separating the side effecting code from the pure functions.&#160; I gave examples in both Haskell and F# to accomplish this goal, although with Haskell it’s more intuitive due to encapsulating the side effects within the IO monad.&#160; This time, let’s cover how we can abstract the monadic code through the use of type classes.&#160; Using the book, Real World Haskell, has opened up a lot of possibilities in this area.</p>
<ul>
<li><a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2008/12/05/functional-programming-unit-testing.aspx">Part 1 &#8211; xUnit Frameworks &#8211; HUnit</a></li>
<li><a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2008/12/11/functional-programming-unit-testing-part-2.aspx">Part 2 &#8211; Property-Based Tests &#8211; QuickCheck</a></li>
<li><a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2008/12/15/functional-programming-unit-testing-part-3.aspx">Part 3 &#8211; QuickCheck + xUnit Tests Together</a></li>
<li><a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2008/12/21/functional-programming-unit-testing-part-4.aspx">Part 4 &#8211; Code Coverage</a></li>
<li><a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2009/01/02/functional-programming-unit-testing-part-5.aspx">Part 5 – Keeping Things Pure</a></li>
</ul>
<p>&#160;</p>
<h2>Refactoring Again</h2>
<p>I want to revisit our topic of refactoring that in the last post.&#160; In this post and the next couple of posts, I want to explore additional areas with refactoring including the following:</p>
<ul>
<li>Keeping Things Pure – covered last post</li>
<li>Monadic Isolation for Testing </li>
<li>Refactoring with frameworks (HLint, etc) </li>
</ul>
<p>In this post, let’s cover how we can abstract away the side effecting into a pure, controlled environment for testing.</p>
<p>&#160;</p>
<h2>Abstracting Towards Purity</h2>
<p>In the Haskell world, there is both a blessing and a curse associated with the IO monad in how powerful it is.&#160; The power comes from helping us avoid purity mistakes, but since there aren’t any grades of IO monads meaning to the level of what it can and cannot do, it could be a source of problems.&#160; Taking an idea from the Real World Haskell book, we can not only tame the IO monad, but as well, hide it so that we could test our functions without actually causing any IO operations to take place.</p>
<p>In order to do this, we could specify a type class with specifies the interface we wish to expose to this monad.&#160; If you’re not familiar with type classes, it’s a way that we can specify a set of functions that can have different implementations based upon the type given.&#160; They could be mistaken for generic interfaces in the .NET world, but in fact they are quite different and a bit more powerful.&#160; Let’s go ahead and define a type class for dealing with database interactions using HDBC and ODBC so that we could abstract away the IO and instead stub our return.&#160; </p>
<div style="font-family: courier new"><font color="#008000">&#8211; file SqlAbstraction.hs</font></div>
<div style="font-family: courier new">&#160;</div>
<div style="font-family: courier new"><font color="#0000ff">import</font> <font color="#ff0000"><strong>Control.Monad</strong></font></div>
<div style="font-family: courier new"><font color="#0000ff">import</font> <font color="#ff0000"><strong>Database.HDBC</strong></font> (<font color="#ff0000">SqlValue</font>(..))</div>
<div style="font-family: courier new">&#160;</div>
<div style="font-family: courier new"><font color="#0000ff">class</font>&#160;<font color="#ff0000">Monad</font> m =&gt; <font color="#ff0000">MonadConnection</font> c m | m -&gt; c <font color="#0000ff">where</font>     <br />&#160; <font color="#000080"><strong>connectODBC</strong></font> :: <font color="#ff0000">String</font> -&gt; m c     <br />&#160; <font color="#000080"><strong>quickQuery&#8217;</strong></font> :: c -&gt; <font color="#ff0000">String</font> -&gt; [<font color="#ff0000">SqlValue</font>] -&gt; m [[<font color="#ff0000">SqlValue</font>]]     <br />&#160; <font color="#000080"><strong>run</strong></font> :: c -&gt; <font color="#ff0000">String</font> -&gt; [<font color="#ff0000">SqlValue</font>] -&gt; m <font color="#ff0000">Integer</font>     <br />&#160; <font color="#000080"><strong>commit</strong></font> :: c -&gt; m()     <br />&#160; <font color="#000080"><strong>disconnect</strong></font> :: c -&gt; m()</div>
<p>Now that we’ve defined what is allowed in our monadic abstraction, let’s stub out what some of these returns might be.&#160; In order to do that, we need a monad that does nothing more than returns the original value, which is the Identity monad.&#160; We can then implement an instance of the Identity monad on top of our abstraction such as the following.</p>
<div style="font-family: courier new"><span style="color: green">&#8211;</span> file SqlAbstraction.hs     </p>
<p><font color="#0000ff">instance</font>&#160;<font color="#ff0000">MonadConnection String Identity</font>&#160;<font color="#0000ff">where</font>     <br />&#160; connectODBC connString = <font color="#000080">return</font> connString&#160; <br />&#160; quickQuery&#8217; conn cmd params =&#160;&#160; <br />&#160;&#160;&#160; <font color="#000080">return</font> [[<font color="#ff0000">SqlInteger</font> 1]]     <br />&#160; run conn cmd params = <font color="#000080">return</font> 0&#160; <br />&#160; commit conn = <font color="#000080">return</font> ()&#160; <br />&#160; disconnect conn = <font color="#000080">return</font> ()</div>
<p>Now running our implementation of a given function that uses this monad is simple and would require nothing more than the following and yield a pure value.</p>
<div style="font-family: courier new">ghci&gt; :t runIdentity someFunction <span style="color: green">&#8211;</span> replace with a real function</div>
<div style="font-family: courier new">runIdentity someFunction :: Bool</div>
<div style="font-family: courier new">ghci&gt; runIdentity someFunction</div>
<div style="font-family: courier new">True</div>
<p>Now that we understand that we can stub out our return values from the monad instance, we could also look at what the real implementation might look like.</p>
<div style="font-family: courier new"><span style="color: green">&#8211;</span><font color="#008000"> file SqlAbstraction.hs</font>&#160; </p>
<p><font color="#0000ff">import</font> qualified <font color="#ff0000">Database.HDBC</font>&#160; <br /><font color="#0000ff">import</font> qualified <font color="#ff0000">Database.HDBC.ODBC</font>&#160; </p>
<p><font color="#0000ff">instance</font>&#160;<font color="#ff0000">MonadConnection Database.HDBC.ODBC.Connection IO</font>&#160;<font color="#0000ff">where</font>     <br />&#160; connectODBC = <font color="#ff0000">Database.HDBC.ODBC</font>.connectODBC&#160; <br />&#160; quickQuery&#8217; = <font color="#ff0000">Database.HDBC</font>.quickQuery&#8217;&#160; <br />&#160; run = <font color="#ff0000">Database.HDBC</font>.run&#160; <br />&#160; commit = <font color="#ff0000">Database.HDBC</font>.commit&#160; <br />&#160; disconnect = <font color="#ff0000">Database.HDBC</font>.disconnect </div>
<p>We realize once I run the Identity version that because I’m getting a pure value with deterministic input based upon my stubs, I could write my tests in either HUnit, the xUnit style of testing, or just as well, I could use QuickCheck to verify the results.&#160; In this instance, I’ll use HUnit to run through this because my inputs are well defined.</p>
<div style="font-family: courier new"><strong><font color="#000080">setSchema_ReturnSchema</font> :: <font color="#ff0000">Test</font>       <br /></strong>setSchema_ReturnSchema =&#160; <br />&#160;&#160;&#160; <font color="#ff0000">TestCase</font> $ assertEqual <font color="#008000">&quot;Should get schema&quot;</font> 1&#160; <br />&#160;&#160;&#160;&#160;&#160; (runIdentity $ setSchema <font color="#008000">&quot;testConn&quot;</font> [<font color="#008000">&quot;schema_version&quot;</font>])     <br />&#160;&#160;&#160;&#160; <br /><strong><font color="#000080">setSchema_InsertSchema</font> :: <font color="#ff0000">Test</font></strong>     <br />setSchema_InsertSchema =&#160; <br />&#160;&#160;&#160; <font color="#ff0000">TestCase</font> $ assertEqual <font color="#008000">&quot;Should create schema with 0&quot;</font> 0     <br />&#160;&#160;&#160;&#160;&#160; (runIdentity $ setSchema <font color="#008000">&quot;testConn&quot;</font> [<font color="#008000">&quot;foobar&quot;</font>])     </p>
<p><strong><font color="#000080">setSchema</font> :: <font color="#ff0000">MonadConnection</font> c m =&gt; c -&gt; [<font color="#ff0000">String</font>] -&gt; m <font color="#ff0000">Int</font></strong>     <br />setSchema conn tables =     <br />&#160;&#160;&#160; <font color="#0000ff">if</font>&#160;<font color="#008000">&quot;schema_version&quot;</font>&#160;<strong><font color="#000080">`elem`</font></strong> tables     <br />&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">then do</font> r &lt;- quickQuery&#8217; conn <font color="#008000">&quot;SELECT version FROM schema_version&quot;</font> []     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">case</font> r <font color="#0000ff">of</font>     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; [[x]] -&gt; <font color="#000080">return</font> (fromSql x)     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; x -&gt; <font color="#000080">fail</font> $ <font color="#008000">&quot;Unexpected result in setSchema: &quot;</font> ++ show x     <br />&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">else do</font> run conn <font color="#008000">&quot;CREATE TABLE schema_version (version INTEGER)&quot;</font> []     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; run conn <font color="#008000">&quot;INSERT INTO schema_version VALUES (0)&quot;</font> []     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; commit conn     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#000080">return</font> 0</div>
<p>Above is a simple implementation with the tests I defined to flush out the behavior of what setSchema should do.&#160; The two cases define whether I already have a schema version or I don’t and act appropriately.&#160; I can then run the tests to verify the behavior.</p>
<div style="font-family: courier new">ghci&gt; runTestTT $ TestList [setSchema_ReturnSchema, setSchema_InsertSchema]    <br />Cases: 2&#160; Tried: 2&#160; Errors: 0&#160; Failures: 0     <br />Counts {cases = 2, tried = 2, errors = 0, failures = 0}</div>
<p>Not only could we test with stubs, but as well, we can capture which methods are called by logging all calls made to our MonadConnection functions through the use of the Writer monad.&#160; This way, we can determine through examining our log afterwards which functions were called, and which were not.&#160; First, we need to define even operations for all items that we care about.&#160; Then we need to tell the Writer monad how to capture our events.&#160; Let’s define how we might do that.</p>
<div style="font-family: courier new"><span style="color: green">&#8211;</span><font color="#008000">file SqlAbstraction.hs</font>     </p>
<p><font color="#0000ff">import</font>&#160;<font color="#ff0000">Control.Monad.Writer</font>     </p>
<p><font color="#0000ff">data</font>&#160;<font color="#ff0000">Event</font> = <font color="#ff0000">Open String</font>     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | <font color="#ff0000">Query String String</font> [<font color="#ff0000">SqlValue</font>]     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | <font color="#ff0000">Run String String</font> [<font color="#ff0000">SqlValue</font>]     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | <font color="#ff0000">Commit String      <br /></font>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | <font color="#ff0000">Disconnect String</font>     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">deriving</font> (<font color="#ff0000">Show</font>, <font color="#ff0000">Eq</font>)     </p>
<p><font color="#0000ff">newtype</font>&#160;<font color="#ff0000">WriterIO</font> a = <font color="#ff0000">W</font> { runW :: <font color="#ff0000">Writer</font> [<font color="#ff0000">Event</font>] a}     <br />&#160; deriving (Monad, MonadWriter [<font color="#ff0000">Event</font>])     <br />&#160;&#160; <br /><strong><font color="#000080">runWriterIO</font> :: <font color="#ff0000">WriterIO</font> a -&gt; (a, [<font color="#ff0000">Event</font>])</strong>     <br />runWriterIO = runWriter . runW     </p>
<p><font color="#0000ff">instance</font>&#160;<font color="#ff0000">MonadConnection String WriterIO</font>&#160;<font color="#0000ff">where</font>     <br />&#160; connectODBC connString = tell [<font color="#ff0000">Open </font>connString] &gt;&gt; return connString     <br />&#160; quickQuery&#8217; conn cmd params =&#160; <br />&#160;&#160;&#160; tell [<font color="#ff0000">Query </font>conn cmd params] &gt;&gt;&#160; <br />&#160;&#160;&#160; return [[<font color="#ff0000">SqlInteger</font> 1]    <br />&#160; run conn cmd params= tell [<font color="#ff0000">Run </font>conn cmd params] &gt;&gt; return 0     <br />&#160; commit conn = tell [<font color="#ff0000">Commit </font>conn]     <br />&#160; disconnect conn = tell [<font color="#ff0000">Disconnect </font>conn]</div>
<p>In our MonadConnection instance, we are not only returning the values as before, but we are also using the tell function to log certain information about each function as they are called.&#160; This way, when parsing the results of the Event list, we can determine whether our expectations were met.&#160; Let’s write a simple example of how it actually works to capture the results.&#160; Imagine this contrived example.</p>
<div style="font-family: courier new"><strong><font color="#000080">hasRecord</font> :: <font color="#ff0000">MonadConnection</font> c m =&gt; m <font color="#ff0000">Bool</font></strong>     <br />hasRecord = <font color="#0000ff">do</font>     <br />&#160; conn &lt;- connectODBC <font color="#008000">&quot;dsn=testdb&quot;</font>     <br />&#160; r &lt;- quickQuery&#8217; conn <font color="#008000">&quot;SELECT * FROM testdb WHERE id &lt;= ?&quot;</font>&#160; <br />&#160;&#160;&#160; [toSql (2 :: <font color="#ff0000">Int</font>)]     <br />&#160; disconnect conn     <br />&#160; <font color="#000080">return</font> (length r &gt; 0)</div>
<div style="font-family: courier new">&#160;</div>
<p>Running this example is as easy as above from the command line.&#160; Let’s look at what it might produce:</p>
<div style="font-family: courier new">ghci&gt; :t runWriterIO hasRecord</div>
<div style="font-family: courier new">runWriterIO hasRecord :: (Bool, [Event])</div>
<div style="font-family: courier new">ghci&gt; runWriterIO hasRecord    <br />(True,[Open &quot;dsn=testdb&quot;,Query &quot;dsn=testdb&quot; &quot;SELECT * FROM testdb WHERE id &lt;= ?&quot;     <br /> [SqlInt32 2],Disconnect &quot;dsn=testdb&quot;])</div>
<p>What this was able to do was not only return the value, but also the logged events based upon what was called with the given arguments so that I may use any number of functions to analyze the event list.&#160; Let’s write one last test against our setSchema function where we make sure that we’re committing the transaction if the schema_version table does not exist.&#160; We recorded an action of Commit which should show up in our results, so we’re going to look for that as part of our test.</p>
<div style="font-family: courier new"><strong><font color="#000080">setSchema_CommitTrans</font> :: <font color="#ff0000">Test</font></strong>     <br />setSchema_CommitTrans =     <br />&#160;&#160;&#160; <font color="#ff0000">TestCase</font> $ assertBool <font color="#008000">&quot;Should commit transaction&quot;</font>     <br />&#160;&#160;&#160;&#160;&#160; (verifyCommit (runWriterIO $ setSchema <font color="#008000">&quot;testConn&quot;</font> [<font color="#008000">&quot;foobar&quot;</font>]))     <br />&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">where</font> verifyCommit res = <font color="#0000ff">let</font> (r, a) = res <font color="#0000ff">in</font>     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Commit <font color="#008000">&quot;testConn&quot;</font>&#160;<font color="#000080"><strong>`elem`</strong></font> a</div>
<div style="font-family: courier new">&#160;</div>
<p>Now that we’ve defined the test, we can run it to verify the result.</p>
<div style="font-family: courier new">ghci&gt; runTestTT setSchema_CommitTrans    <br />Cases: <span style="color: maroon">1</span>&#160; Tried: <span style="color: maroon">1</span>&#160; Errors: <span style="color: maroon">0</span>&#160; Failures: <span style="color: maroon">0</span>     <br />Counts {cases = <span style="color: maroon">1</span>, tried = <span style="color: maroon">1</span>, errors = <span style="color: maroon">0</span>, failures = <span style="color: maroon">0</span>}</div>
<div style="font-family: courier new">&#160;</div>
<p>As you can see, we’re now able to detect when things happen in this monadic abstraction.&#160; This leads to a lot of very interesting possibilities.&#160; Especially if we take this example further to allow for some arbitrary IO instances using lifting and monad transformers.</p>
<p>The question is, are there any downsides?&#160;&#160; There is a bit of work to stub out these samples, and once set, not easy to change for your given file.&#160; But once you understand how to do this, testing in a pure environment becomes quite easy.&#160; Taking lessons learned from the Haskell world, could we apply them to F#?</p>
<p>&#160;</p>
<h2>Monadic Abstraction in F#?</h2>
<p>Understanding what we know about monads in Haskell, what I’d like is the opportunity to do the same with F# monads.&#160; You may recall that that the standard for the monad in Haskell looks like the following.</p>
<div style="font-family: courier new"><font color="#0000ff">class</font>&#160;<font color="#ff0000">Monad</font> m <font color="#0000ff">where</font>     <br />&#160; (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b     <br />&#160; (&gt;&gt;) :: m a -&gt; m b -&gt; m b     <br />&#160; <font color="#000080">return</font> :: a -&gt; m a     <br />&#160; <font color="#000080">fail</font> :: <font color="#ff0000">String</font> -&gt; m a</div>
<div style="font-family: courier new">&#160;</div>
<p>As you can see, it’s using a typeclass to define the monad in that we could easily swap out instances.&#160; In F#, monadic instances by a simple class which contains Delay, Bind and Return functions as the bare minimum defined such as the following outline:</p>
<div style="font-family: courier new"><span style="color: blue">type</span> MonadBuilder =     <br />&#160; <span style="color: blue">abstract</span>&#160;<span style="color: blue">member</span> Bind <span style="color: blue">:</span>&#160;<span style="color: blue">#</span>Monad&lt;&#8217;a&gt; * <span style="color: blue">(</span>&#8216;a <span style="color: blue">-&gt;</span>&#160;<span style="color: blue">#</span>Monad&lt;&#8217;b&gt;<span style="color: blue">)</span>&#160;<span style="color: blue">-&gt;</span>&#160;<span style="color: blue">#</span>Monad&lt;&#8217;b&gt;     <br />&#160; <span style="color: blue">abstract</span>&#160;<span style="color: blue">member</span> Return <span style="color: blue">:</span> &#8216;a <span style="color: blue">-&gt;</span>&#160;<span style="color: blue">#</span>Monad&lt;&#8217;a&gt;     <br />&#160; <span style="color: blue">abstract</span>&#160;<span style="color: blue">member</span> Delay <span style="color: blue">:</span>&#160;<span style="color: blue">(</span>unit <span style="color: blue">-&gt;</span> &#8216;a<span style="color: blue">)</span> –<span style="color: blue">&gt;</span> &#8216;a</div>
<div style="font-family: courier new">&#160;</div>
<p>Where #Monad is replaced with a concrete type of some sort such as ‘a list, ‘a option, Async&lt;’a&gt; and so on.&#160; Using this as an outline, we can define such things as the Identity Monad such as the following.</p>
<div style="font-family: courier new"><span style="color: blue">type</span> Identity&lt;&#8217;a&gt; = I <span style="color: blue">of</span> &#8216;a&#160; </p>
<p><span style="color: blue">type</span> IdentityBuilder<span style="color: blue">(</span><span style="color: blue">)</span> =&#160; <br />&#160; <span style="color: blue">member</span> x<span style="color: blue">.</span>Bind<span style="color: blue">(</span>x<span style="color: blue">:</span>Identity&lt;&#8217;a&gt;, k<span style="color: blue">:</span>&#8216;a <span style="color: blue">-&gt;</span> Identity&lt;&#8217;b&gt;<span style="color: blue">)</span> =&#160; <br />&#160;&#160;&#160; <span style="color: blue">match</span> x, k <span style="color: blue">with</span>&#160; <br />&#160;&#160;&#160; <span style="color: blue">|</span> I x, f <span style="color: blue">-&gt;</span> f x&#160;&#160; <br />&#160; <span style="color: blue">member</span> x<span style="color: blue">.</span>Return<span style="color: blue">(</span>i<span style="color: blue">:</span>&#8216;a<span style="color: blue">)</span>&#160;<span style="color: blue">:</span> Identity&lt;&#8217;a&gt; = I i&#160; <br />&#160; <span style="color: blue">member</span> x<span style="color: blue">.</span>Delay<span style="color: blue">(</span>f<span style="color: blue">)</span> = f<span style="color: blue">(</span><span style="color: blue">)</span>&#160; <br />&#160;&#160;&#160; <br /><span style="color: blue">let</span> ident = <span style="color: blue">new</span> IdentityBuilder<span style="color: blue">(</span><span style="color: blue">)</span>&#160; </p>
<p><span style="color: blue">let</span> runIdentity = <span style="color: blue">function</span>     <br />&#160; <span style="color: blue">|</span> I x <span style="color: blue">-&gt;</span> x     <br />&#160;&#160;&#160; <br /><span style="color: blue">let</span> iResult =&#160;&#160; <br />&#160; ident <span style="color: blue">{</span>&#160;<span style="color: blue">let</span>! f = I <span style="color: maroon">&quot;foo&quot;</span>&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> f&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">}</span>     <br /><span style="color: blue">let</span> result = runIdentity iResult</div>
<div style="font-family: courier new">&#160;</div>
<p>When we look at the above code, we realize that there really isn’t an easy way to abstract this in such a way that we could say, substitute an Identity monad for an async monad and expect it to continue with the code using the current way that F# sugars the monadic syntax.&#160; It’s not to say it might not be able to get done, it’s just not worth the effort at this point using the existing sugaring.&#160; Others have taken different angles such as such as with <a href="http://blog.matthewdoig.com/?p=104">simple operators</a> and <a href="http://blog.matthewdoig.com/?p=120">template expansion</a>, but in this case, I don’t think that’s enough to help.&#160; Instead, it’s best to use the existing mocking frameworks that we already have to trace such behaviors.&#160; The support of monads in F# at this juncture is limited by this fact that one monad cannot be substituted for another.&#160; But this doesn’t stop me from enjoying monads in F#, but that’s for another post.</p>
<p>&#160;</p>
<h2>Conclusion</h2>
<p>As you can see, monadic abstractions using type classes can be very useful in order to isolate side effects and test with pure values.&#160; This gives us the ability to not only stub out our values, but also record the actions taken in a mock-ish way so that we observe our expectations.&#160; Unfortunately, the way that F# monads were implemented does not lend itself to this operation, but my hope is that this is supported at some point.</p>
<p>There is still more to come in this series, including an exploration of cleaning up our code.&#160; With such tools as HLint and others, we can better understand the language by some of the suggestions given.&#160; And maybe you too could follow the <a href="http://www.willamette.edu/~fruehr/haskell/evolution.html">Haskell Evolution</a>, and maybe F# one in the future?</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/matthewpodwysocki/category/f/" title="View all posts in F#" rel="category tag">F#</a>, <a href="http://codebetter.com/matthewpodwysocki/category/functional-programming/" title="View all posts in Functional Programming" rel="category tag">Functional Programming</a>, <a href="http://codebetter.com/matthewpodwysocki/category/haskell/" title="View all posts in Haskell" rel="category tag">Haskell</a>, <a href="http://codebetter.com/matthewpodwysocki/category/tddbdd/" title="View all posts in TDD/BDD" rel="category tag">TDD/BDD</a>. Bookmark the <a href="http://codebetter.com/matthewpodwysocki/2009/01/10/functional-programming-unit-testing-part-6/" title="Permalink to Functional Programming Unit Testing &#8211; Part 6" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/matthewpodwysocki/2009/01/10/functional-programming-unit-testing-part-6/feed/" title="Comments RSS to Functional Programming Unit Testing &#8211; Part 6" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-100 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/matthewpodwysocki/2009/01/05/2008-the-year-that-was/" rel="prev"><span class="meta-nav">&larr;</span> 2008 – The Year that Was</a></div>
					<div class="nav-next"><a href="http://codebetter.com/matthewpodwysocki/2009/01/13/how-would-the-clr-be-different/" rel="next">How would the CLR Be Different? <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
					<li id="dsq-comment-241">
					<div id="dsq-comment-header-241" class="dsq-comment-header">
						<cite id="dsq-cite-241">
								<span id="dsq-author-user-241">Jason Kikel</span>
							</cite>
					</div>
					<div id="dsq-comment-body-241" class="dsq-comment-body">
						<div id="dsq-comment-message-241" class="dsq-comment-message"><p>I think your F# monad builder needs a Let member as well.  Bind takes care of let! and do! whereas Let desugars let and do.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-242">
					<div id="dsq-comment-header-242" class="dsq-comment-header">
						<cite id="dsq-cite-242">
	http://podwysocki.codebetter.com							<span id="dsq-author-user-242">Matthew.Podwysocki</span>
							</cite>
					</div>
					<div id="dsq-comment-body-242" class="dsq-comment-body">
						<div id="dsq-comment-message-242" class="dsq-comment-message"><p>@Jason,</p>
<p>That is not true anymore.  Needing a let has been deprecated according to the documentation now.  The bare minimum is Bind, Delay and Return.</p>
<p>Matt</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-243">
					<div id="dsq-comment-header-243" class="dsq-comment-header">
						<cite id="dsq-cite-243">
								<span id="dsq-author-user-243">Jason Kikel</span>
							</cite>
					</div>
					<div id="dsq-comment-body-243" class="dsq-comment-body">
						<div id="dsq-comment-message-243" class="dsq-comment-message"><p>Sweet.</p>
<p>By the way, great work here.</p>
</div>
					</div>
				</li>
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/matthewpodwysocki/2009/01/10/functional-programming-unit-testing-part-6/ ';
	var disqus_identifier = '100 /blogs/matthew.podwysocki/archive/2009/01/10/functional-programming-unit-testing-part-6.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'matthewpodwysocki';
	var disqus_title = "Functional Programming Unit Testing &#8211; Part 6";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData — fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=100');
		});
					};
	var facebookXdReceiverPath = 'http://cdn1.codebetter.com/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/matthewpodwysocki\/2009\/01\/10\/functional-programming-unit-testing-part-6\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.989 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-31 12:31:46 -->
<!-- super cache -->