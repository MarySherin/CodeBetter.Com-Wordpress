<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Generate an Excel XLS spreadsheet from T-Sql in Sql Server | Raymond Lewallen</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/raymondlewallen/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/raymondlewallen/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/raymondlewallen/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/raymondlewallen/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/raymondlewallen/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Raymond Lewallen' href='http://codebetter.com/raymondlewallen/' />
<link rel='start' title='Moving some blog entries' href='http://codebetter.com/raymondlewallen/2004/12/01/moving-some-blog-entries/' />
<link rel='prev' title='TestDriven.Net version 1.1 has been released' href='http://codebetter.com/raymondlewallen/2005/05/02/testdriven-net-version-1-1-has-been-released/' />
<link rel='next' title='Performance Monitoring &#8211; JIT compilations' href='http://codebetter.com/raymondlewallen/2005/05/05/performance-monitoring-jit-compilations/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/' />
<link rel='shortlink' href='http://codebetter.com/raymondlewallen/?p=115' />
<link rel="stylesheet" href="http://codebetter.com/raymondlewallen/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/raymondlewallen/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-115" class="post-115 post type-post status-publish format-standard hentry category-most-popular category-sql-development">
					<h1 class="entry-title">Generate an Excel XLS spreadsheet from T-Sql in Sql Server</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/raymondlewallen/author/raymondlewallen/" title="View all posts by raymondlewallen">raymondlewallen</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/" title="11:41 am" rel="bookmark"><span class="entry-date">May 4, 2005</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/raymondlewallen/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/raymondlewallen/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/raymondlewallen/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>Sometimes you find these really old files floating around on your<br />
harddrive and you forget that you ever downloaded them. Here is one<br />
such example. I have no idea where I got this or who to credit for its<br />
creation, but I&#8217;ve had it for awhile and came across it and thought it<br />
would be something nice to share with you, as I’m sure it is something<br />
of great help to many of you, especially if you are limited in your<br />
experience on creating DTS packages, which is another way, and<br />
preferred way under most circumstances, to get data from Sql to<br />
Excel.&nbsp; This<br />
is a T-SQL script that uses the system stored procedures sp_OA* for<br />
creating and handling OLE objects, ADO, Jet and a linked server to<br />
create and<br />
populate an XLS file from a select statement.&nbsp; By default, if the<br />
XLS file already exists, the result of the query will get appended to<br />
the worksheet.&nbsp; You&#8217;ll have to add some code to check for and<br />
delete the file before creating if that is your desired behavior.&nbsp;<br />
Oh, and I used this a long time ago<br />
with some minor code changes and it worked fine, but this is the<br />
original script using the pubs database, so there are changes you’ll<br />
have to make, and they should be fairly obvious to you.
</p>
<p>
<span style="font-weight: bold">Note:</span> DTS packages are the<br />
preferred way of handling this type of data transfer, especially when<br />
scheduled, so don&#8217;t be hasty to implement this without looking at a DTS<br />
solution first.&nbsp; That being said, I&#8217;m sure there are those of you<br />
out there who can find usefulness out of this script.
</p>
<fieldset>
<legend>Create and Excel spreadsheet via T-Sql</legend>
</p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Create XLS script DAL &#8211; </span><span style="font-size: 10pt;font-family: 'Lucida Console'">04/24/2003</span><span style="font-size: 10pt;font-family: 'Lucida Console'"></span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Designed for Agent scheduling, turn on &#8220;Append output for step history&#8221;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Search for %%% to find adjustable constants and other options</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Uses OLE for </span><span style="font-size: 10pt;font-family: 'Lucida Console'">ADO</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> and OLE DB to create the XLS file if it does not exist</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Linked server requires the XLS to exist before creation</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Uses OLE ADO to Create the XLS Worksheet for use as a table by T-SQL</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Uses Linked Server to allow T-SQL access to XLS table</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Uses T-SQL to populate te XLS worksheet, very fast</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">PRINT &#8216;Begin CreateXLS script at &#8216;+RTRIM(CONVERT(varchar(24),GETDATE(),121))+&#8217; &#8216;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">PRINT &#8221;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">GO</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET NOCOUNT ON</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">DECLARE @Conn int &#8212; ADO Connection object to create XLS</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @hr int &#8212; OLE return value</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @src varchar(255) &#8212; OLE Error Source</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @desc varchar(255) &#8212; OLE Error Description</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @Path varchar(255) &#8212; Drive or UNC path for XLS</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @Connect varchar(255) &#8212; OLE DB Connection string for Jet 4 Excel ISAM</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @WKS_Created bit &#8212; Whether the XLS Worksheet exists</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @WKS_Name varchar(128) &#8212; Name of the XLS Worksheet (table)</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @ServerName nvarchar(128) &#8212; Linked Server name for XLS</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @DDL varchar(8000) &#8212; Jet4 DDL for the XLS WKS table creation</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @SQL varchar(8000) &#8212; INSERT INTO XLS T-SQL</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @Recs int &#8212; Number of records added to XLS</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @Log bit &#8212; Whether to log process detail</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Init variables</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SELECT @Recs = 0</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; %%% 1 = Verbose output detail, helps find problems, 0 = minimal output detail</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @Log = 1 </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% assign the UNC or path and name for the XLS file, requires Read/Write access</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>must be accessable from server via SQL Server service account</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>&amp; SQL Server Agent service account, if scheduled</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @Path = &#8216;C:\TEMP\Test_&#8217;+CONVERT(varchar(10),GETDATE(),112)+&#8217;.xls&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; assign the </span><span style="font-size: 10pt;font-family: 'Lucida Console'">ADO</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> connection string for the XLS creation</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @Connect = &#8216;Provider=Microsoft.Jet.OLEDB.4.0;Data Source=&#8217;+@Path+&#8217;;Extended Properties=Excel 8.0&#8242;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% assign the Linked Server name for the XLS population</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @ServerName = &#8216;EXCEL_TEST&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% Rename Table as required, this will also be the XLS Worksheet name</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @WKS_Name = &#8216;People&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% Table creation DDL, uses Jet4 syntax, </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Text data type = varchar(255) when accessed from T-SQL</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @DDL = &#8216;CREATE TABLE &#8216;+@WKS_Name+&#8217; (SSN Text, Name Text, Phone Text)&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% T-SQL for table population, note the 4 part naming required by Jet4 OLE DB</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>INSERT INTO SELECT, INSERT INTO VALUES, and EXEC sp types are supported</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Linked Server does not support SELECT INTO types</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @SQL = &#8216;INSERT INTO &#8216;+@ServerName+&#8217;&#8230;&#8217;+@WKS_Name+&#8217; (SSN, Name, Phone) &#8216;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @SQL = @SQL+&#8217;SELECT au_id AS SSN&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @SQL = @SQL+&#8217;, LTRIM(RTRIM(ISNULL(au_fname,&#8221;&#8221;)+&#8221; &#8221;+ISNULL(au_lname,&#8221;&#8221;))) AS Name&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @SQL = @SQL+&#8217;, phone AS Phone &#8216;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET @SQL = @SQL+&#8217;FROM pubs.dbo.authors&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @Log = 1 PRINT &#8216;Created OLE ADODB.Connection object&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Create the </span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> object</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">EXEC @hr = sp_OACreate &#8216;ADODB.Connection&#8217;, @Conn OUT</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @hr &lt;&gt; 0 &#8212; have to use &lt;&gt; as OLE / </span><span style="font-size: 10pt;font-family: 'Lucida Console'">ADO</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> can return negative error numbers</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; Return OLE error</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_OAGetErrorInfo @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, @src OUT, @desc OUT </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SELECT Error=convert(varbinary(4),@hr), Source=@src, Description=@desc</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>RETURN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @Log = 1 PRINT char(9)+&#8217;Assigned ConnectionString property&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Set a the </span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> object&#8217;s ConnectionString property</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Work-around for error using a variable parameter on the Open method</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">EXEC @hr = sp_OASetProperty @Conn, &#8216;ConnectionString&#8217;, @Connect</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @hr &lt;&gt; 0</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; Return OLE error</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_OAGetErrorInfo @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, @src OUT, @desc OUT </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SELECT Error=convert(varbinary(4),@hr), Source=@src, Description=@desc</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>RETURN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @Log = 1 PRINT char(9)+&#8217;Open Connection to XLS, for file Create or Append&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Call the Open method to create the XLS if it does not exist, can&#8217;t use parameters</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">EXEC @hr = sp_OAMethod @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, &#8216;Open&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @hr &lt;&gt; 0</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; Return OLE error</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_OAGetErrorInfo @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, @src OUT, @desc OUT </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SELECT Error=convert(varbinary(4),@hr), Source=@src, Description=@desc</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>RETURN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% This section could be repeated for multiple Worksheets (Tables)</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @Log = 1 PRINT char(9)+&#8217;Execute DDL to create &#8221;&#8217;+@WKS_Name+&#8221;&#8217; worksheet&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Call the Execute method to Create the work sheet with the @WKS_Name caption, </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>which is also used as a Table reference in T-SQL</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Neat way to define column data types in Excel worksheet</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Sometimes converting to text is the only work-around for Excel&#8217;s General </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Cell formatting, even though the Cell contains Text, Excel tries to format</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>it in a &#8220;Smart&#8221; way, I have even had to use the single quote appended as the</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>1st character in T-SQL to force Excel to leave it alone</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">EXEC @hr = sp_OAMethod @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, &#8216;Execute&#8217;, NULL, @DDL, NULL, 129 &#8212; adCmdText + adExecuteNoRecords</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; 0x80040E14 for table exists in </span><span style="font-size: 10pt;font-family: 'Lucida Console'">ADO</span><span style="font-size: 10pt;font-family: 'Lucida Console'"></span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @hr = 0x80040E14 </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; kludge, skip 0&#215;80042732 for ADO Optional parameters (NULL) in SQL7</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>OR @hr = 0&#215;80042732</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; Trap these OLE Errors</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IF @hr = 0x80040E14</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>PRINT char(9)+&#8221;&#8221;+@WKS_Name+&#8221;&#8217; Worksheet exists for append&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SET @WKS_Created = 0</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SET @hr = 0 &#8212; ignore these errors</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @hr &lt;&gt; 0</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; Return OLE error</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_OAGetErrorInfo @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, @src OUT, @desc OUT </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SELECT Error=convert(varbinary(4),@hr), Source=@src, Description=@desc</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>RETURN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @Log = 1 PRINT &#8216;Destroyed OLE ADODB.Connection object&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Destroy the </span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> object, +++ important to not leak memory +++</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">EXEC @hr = sp_OADestroy @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'"></span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF @hr &lt;&gt; 0</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; Return OLE error</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_OAGetErrorInfo @</span><span style="font-size: 10pt;font-family: 'Lucida Console'">Conn</span><span style="font-size: 10pt;font-family: 'Lucida Console'">, @src OUT, @desc OUT </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SELECT Error=convert(varbinary(4),@hr), Source=@src, Description=@desc</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>RETURN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Linked Server allows T-SQL to access the XLS worksheet (Table)</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>This must be performed after the </span><span style="font-size: 10pt;font-family: 'Lucida Console'">ADO</span><span style="font-size: 10pt;font-family: 'Lucida Console'"> stuff as the XLS must exist</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>and contain the schema for the table, or worksheet</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF NOT EXISTS(SELECT srvname from master.dbo.sysservers where srvname = @ServerName)</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IF @Log = 1 PRINT &#8216;Created Linked Server &#8221;&#8217;+@ServerName+&#8221;&#8217; and Login&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_addlinkedserver @server = @ServerName</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp; </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @srvproduct = &#8216;Microsoft Excel Workbook&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp; </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @provider = &#8216;Microsoft.Jet.OLEDB.4.0&#8242;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp; </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @datasrc = @Path</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp; </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>, @provstr = &#8216;Excel 8.0&#8242; </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&#8211; no login name or password are required to connect to the Jet4 ISAM linked server</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_addlinkedsrvlogin @ServerName, &#8216;false&#8217; </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; Have to EXEC the SQL, otherwise the SQL is evaluated </span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>for the linked server before it exists</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">EXEC (@SQL)</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">PRINT char(9)+&#8217;Populated &#8221;&#8217;+@WKS_Name+&#8221;&#8217; table with &#8216;+CONVERT(varchar,@@ROWCOUNT)+&#8217; Rows&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211; %%% Optional you may leave the Linked Server for other XLS operations</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>Remember that the Linked Server will not create the XLS, so remove it</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&#8211;<span>&nbsp;&nbsp; </span>When you are done with it, especially if you delete or move the file</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">IF EXISTS(SELECT srvname from master.dbo.sysservers where srvname = @ServerName)</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">BEGIN</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IF @Log = 1 PRINT &#8216;Deleted Linked Server &#8221;&#8217;+@ServerName+&#8221;&#8217; and Login&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>EXEC sp_dropserver @ServerName, &#8216;droplogins&#8217;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">END</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">GO</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">&nbsp;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">SET NOCOUNT OFF</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">PRINT &#8221;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">PRINT &#8216;Finished CreateXLS script at &#8216;+RTRIM(CONVERT(varchar(24),GETDATE(),121))+&#8217; &#8216;</span></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt"><span style="font-size: 10pt;font-family: 'Lucida Console'">GO</span></p>
</fieldset>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/raymondlewallen/category/most-popular/" title="View all posts in Most Popular" rel="category tag">Most Popular</a>, <a href="http://codebetter.com/raymondlewallen/category/sql-development/" title="View all posts in Sql Development" rel="category tag">Sql Development</a>. Bookmark the <a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/" title="Permalink to Generate an Excel XLS spreadsheet from T-Sql in Sql Server" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/feed/" title="Comments RSS to Generate an Excel XLS spreadsheet from T-Sql in Sql Server" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-115 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/raymondlewallen/2005/05/02/testdriven-net-version-1-1-has-been-released/" rel="prev"><span class="meta-nav">&larr;</span> TestDriven.Net version 1.1 has been released</a></div>
					<div class="nav-next"><a href="http://codebetter.com/raymondlewallen/2005/05/05/performance-monitoring-jit-compilations/" rel="next">Performance Monitoring &#8211; JIT compilations <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

							<div id="comments">


			<h3 id="comments-title">9 Responses to <em>Generate an Excel XLS spreadsheet from T-Sql in Sql Server</em> </h3>


			<ol class="commentlist">
						<li class="comment even thread-even depth-1" id="li-comment-428">
		<div id="comment-428">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.geekblogger.org' rel='external nofollow' class='url'>Generate SQL Script from Excel</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-428">October 24, 2010 at 3:54 am</a></div>

		<div class="comment-body"><p>Hey we have started contest to win Querycell excel add-on by which you can Generate SQL Script from Excel on a single click of mouse.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-427">
		<div id="comment-427">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://qnzrsinc.com/' rel='external nofollow' class='url'>Hncqugcm</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-427">July 14, 2009 at 7:30 pm</a></div>

		<div class="comment-body"><p>t3g906</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-426">
		<div id="comment-426">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Nitin</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-426">March 11, 2009 at 4:28 pm</a></div>

		<div class="comment-body"><p>This code works perfectly fine when data is populated for two or more columns. </p>
<p>It fails if data is populated for only one column.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-425">
		<div id="comment-425">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Alex</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-425">July 16, 2007 at 1:01 pm</a></div>

		<div class="comment-body"><p>Thanks Raymond &#038; David, a very handy script. I have the same problem, loads of scripts from everywhere with no credit info, points out the usefulness of decent header comments.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-424">
		<div id="comment-424">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://blog.davestechshop.net' rel='external nofollow' class='url'>Dave</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-424">July 6, 2007 at 2:55 am</a></div>

		<div class="comment-body"><p>You are right &#8211; I did find this to be of great interest. Thanks for sharing it.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-423">
		<div id="comment-423">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">panxo lopez </cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-423">January 19, 2007 at 1:00 pm</a></div>

		<div class="comment-body"><p>Hello. my name is panxo i from chile south america,<br />
i speak spanish<br />
 yo pienso que ustedes par de sacohueas estan puro weando, tienen que crear un objeto DTS  y configurarlo para que exporte a EXCEL, despues lo llaman con<br />
EXEC @hr = sp_OACreate &#8216;DTS.Package&#8217;, @object OUTPUT<br />
EXEC @hr = sp_OAMethod @object, &#8216;LoadFromStorageFile&#8217;,<br />
 NULL, &#8216;c:\sd\Genera_Mega_SC.dts&#8217;, &#8221;<br />
y listo<br />
ya pues escribamne cualquer cosa<br />
a<br />
<a href="mailto:jaimealarcon@hotmail.com">jaimealarcon@hotmail.com</a><br />
xupenlo!</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-422">
		<div id="comment-422">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Bunjeeb </cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-422">April 23, 2006 at 8:13 am</a></div>

		<div class="comment-body"><p>What is the reason of this Error &#8230;.</p>
<p>0&#215;80004005	Microsoft JET Database Engine	&#8216;C:\TEMP\Test_20060423.xls&#8217; is not a valid path.  Make sure that the path name is spelled correctly and that you are connected to the server on which the file resides.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-421">
		<div id="comment-421">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.codebetter.com/blogs/raymond.lewallen' rel='external nofollow' class='url'>rlewallen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-421">April 17, 2006 at 3:03 pm</a></div>

		<div class="comment-body"><p>As noted in my blog post:</p>
<p>&#8220;Here is one such example. I have no idea where I got this or who to credit for its creation, but I&#8217;ve had it for awhile and came across it and thought it would be something nice to share with you&#8221;</p>
<p>I did not know who the author was, as it had been sitting on my harddrive for so long.  Thank you for pointing out the author.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-420">
		<div id="comment-420">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">EugeneZ</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#comment-420">April 17, 2006 at 2:57 pm</a></div>

		<div class="comment-body"><p>So who is author? you or  David A. Long ?<br />
<a href="http://www.sqlservercentral.com/scripts/contributions/763.asp" rel="nofollow">http://www.sqlservercentral.com/scripts/contributions/763.asp</a></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
			</ol>



								<div id="respond">
				<h3 id="reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/raymondlewallen/2005/05/04/generate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server/#respond" style="display:none;">Cancel reply</a></small></h3>
									<p class="must-log-in">You must be <a href="http://codebetter.com/raymondlewallen/wp-login.php?redirect_to=http%3A%2F%2Fcodebetter.com%2Fraymondlewallen%2F2005%2F05%2F04%2Fgenerate-an-excel-xls-spreadsheet-from-t-sql-in-sql-server%2F">logged in</a> to post a comment.</p>												</div><!-- #respond -->
						
</div><!-- #comments -->

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.318 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-27 09:01:19 -->
<!-- super cache -->